<t-details *ngIf="found;else pageNotFound" collection="Document" [definitionId]="definitionId" [createFunc]="create"
    [cloneFunc]="clone" [mode]="mode" [additionalSelect]="additionalSelect" [masterCrumb]="masterCrumb"
    [detailsCrumb]="detailsCrumb" [idString]="idString" [documentTemplate]="document" [isInactive]="isInactive"
    [documentHeaderTemplate]="documentHeader" [actions]="[
        { template: editDefinition, action: onEditDefinition, showAction: showEditDefinition }
    ]" [sidebarTemplate]="showSidebar ? sidebar: null" [registerPristineFunc]="registerPristineFunc"
    [isDirtyFunc]="isDirtyFunc" [extraParams]="extraParams" [handleFreshExtras]="handleFreshExtras"
    [toolbarTemplate]="toolbar" [encodeCustomStateFunc]="encodeCustomStateFunc" [select]="select"
    [savePreprocessing]="savePreprocessing">

</t-details>

<ng-template #editDefinition> {{ 'EditDefinition' | translate }} </ng-template>

<!-- If definitionId is invalid -->
<ng-template #pageNotFound>
    <t-application-page-not-found [showHome]="!isPopupMode">
    </t-application-page-not-found>
</ng-template>

<!-- Details Crumb -->
<ng-template #detailsCrumb let-model="model">
    <span>{{ formatSerial(model?.SerialNumber) }}</span>
</ng-template>

<!-- Extra toolbar buttons -->
<ng-template #toolbar let-model="model" let-extras="extras" let-isEdit="isEdit">
    <!-- Actions -->
    <div *ngIf="isEdit && showAutoGenerateAll()" class="btn-group" ngbDropdown [placement]="actionsDropdownPlacement">
        <button type="button" class="btn btn-sm t-toolbar-button dropdown-toggle btn-light text-primary t-white-button"
            ngbDropdownToggle>
            <span>{{ 'Actions' | translate }}</span>
        </button>
        <div class="dropdown-menu shadow small" ngbDropdownMenu aria-labelledby="action">
            <div *ngIf="true" container="body">
                <button type="button" class="dropdown-item t-transparent-background btn-light" ngbDropdownItem
                    (click)="onAutoGenerateAll(model, isEdit)" [disabled]="false">
                    {{ 'AutoGenerate' | translate }}
                </button>
            </div>
        </div>
    </div>

    <!-- Email Menu -->
    <t-email-button class="btn-group" *ngIf="model?.Id && !isEdit" [emailTemplates]="emailTemplates"
        [emailCommandPreview]="emailCommandPreviewFactory(model?.Id)" [emailPreview]="emailPreviewFactory(model?.Id)"
        [sendEmail]="sendEmailFactory(model?.Id)">
    </t-email-button>

    <!-- SMS Menu -->
    <t-message-button class="btn-group" *ngIf="model?.Id && !isEdit" [messageTemplates]="messageTemplates"
        [messageCommandPreview]="messageCommandPreviewFactory(model?.Id)" [sendMessage]="sendMessageFactory(model?.Id)">
    </t-message-button>

    <div class="mx-2 d-inline-block"
        *ngIf="!isEdit && showClose(model, extras?.RequiredSignatures) || showClose(model, extras?.RequiredSignatures)">
    </div>

    <!-- Open -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement" [ngbTooltip]="updateStateTooltip(model)"
        container="body" *ngIf="!isEdit && showOpen(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-light t-white-button text-primary t-toolbar-button" (click)="onOpen(model)"
            [disabled]="!hasPermissionToUpdateState(model)">
            <fa-icon icon="undo"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Open" | translate }}</span>
        </button>
    </div>
    <!-- Cancel -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement"
        [ngbTooltip]="cancelTooltip(model, extras?.RequiredSignatures)" container="body"
        *ngIf="!isEdit && showCancel(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-danger t-toolbar-button" (click)="onCancel(model)"
            [disabled]="disableCancel(model, extras?.RequiredSignatures)">
            <fa-icon icon="times"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Cancel" | translate }}</span>
        </button>
    </div>
    <!-- Close -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement"
        [ngbTooltip]="closeTooltip(model, extras?.RequiredSignatures)" container="body"
        *ngIf="!isEdit && showClose(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-success t-toolbar-button" (click)="onClose(model)"
            [disabled]="disableClose(model, extras?.RequiredSignatures)">
            <fa-icon icon="check"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Close" | translate }}</span>
        </button>
    </div>
    <!-- Uncancel -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement" [ngbTooltip]="updateStateTooltip(model)"
        container="body" *ngIf="!isEdit && showUncancel(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-light t-white-button text-primary t-toolbar-button"
            (click)="!isEdit && onUncancel(model)" [disabled]="!hasPermissionToUpdateState(model)">
            <fa-icon icon="undo"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Uncancel" | translate }}</span>
        </button>
    </div>
</ng-template>

<ng-template #documentHeader let-model="model" let-extras="extras" let-isEdit="isEdit">
    <div class="w-100 t-document-header d-flex justify-content-end">

        <!-- +ve states on wide screen -->
        <ng-container *ngIf="isPositiveState(model); else negativeStates">
            <div class="t-flow-chart small d-none d-lg-block">
                <div [class.active]="isStateActive(0, model)" *ngIf="isStateVisible(0, model)">
                    <span>{{'Line_State_0' | translate}}</span>
                </div>
                <div [class.active]="isStateActive(1, model)" *ngIf="isStateVisible(1, model)">
                    <span>{{'Line_State_1' | translate}}</span>
                </div>
                <div [class.active]="isStateActive(2, model)" *ngIf="isStateVisible(2, model)">
                    <span>{{'Line_State_2' | translate}}</span>
                </div>
                <div [class.active]="isStateActive(3, model)" *ngIf="isStateVisible(3, model)">
                    <span>{{'Line_State_3' | translate}}</span>
                </div>
                <div [class.active]="isStateActive(4, model)" *ngIf="isStateVisible(4, model)">
                    <span>{{'Line_State_4' | translate}}</span>
                </div>

                <div [class.active]="isDocumentStateActive(0, model)" *ngIf="isDocumentStateVisible(0, model)">
                    <span>{{'Document_State_0' | translate}}</span>
                </div>
                <div [class.active]="isDocumentStateActive(1, model)" *ngIf="isDocumentStateVisible(1, model)">
                    <span>{{'Document_State_1' | translate}}</span>
                </div>
            </div>

            <!-- +ve states on narrow screen -->
            <div class="small t-lone-state active d-block d-lg-none">
                <span *ngIf="isStateActive(0, model)">{{ 'Line_State_0' | translate }}</span>
                <span *ngIf="isStateActive(1, model)">{{ 'Line_State_1' | translate }}</span>
                <span *ngIf="isStateActive(2, model)">{{ 'Line_State_2' | translate }}</span>
                <span *ngIf="isStateActive(3, model)">{{ 'Line_State_3' | translate }}</span>
                <span *ngIf="isStateActive(4, model)">{{ 'Line_State_4' | translate }}</span>

                <span *ngIf="isDocumentStateActive(0, model)">{{ 'Document_State_0' | translate }}</span>
                <span *ngIf="isDocumentStateActive(1, model)">{{ 'Document_State_1' | translate }}</span>
            </div>
        </ng-container>

        <!-- -ve states -->
        <ng-template #negativeStates>
            <div class="small t-lone-state active d-block">
                <span *ngIf="isNegativeStateActive(1, model)">{{ 'Line_State_minus_1' | translate }}</span>
                <span *ngIf="isNegativeStateActive(2, model)">{{ 'Line_State_minus_2' | translate }}</span>
                <span *ngIf="isNegativeStateActive(3, model)">{{ 'Line_State_minus_3' | translate }}</span>
                <span *ngIf="isNegativeStateActive(4, model)">{{ 'Line_State_minus_4' | translate }}</span>

                <span *ngIf="isNegativeDocumentStateActive(1, model)">{{ 'Document_State_minus_1' | translate }}</span>
            </div>
        </ng-template>
    </div>
</ng-template>

<!-- Edit/View Template -->
<ng-template #document let-model="model" let-extras="extras" let-isEdit="isEdit">

    <!-- Serial Number -->
    <t-form-group class="col-12 mb-2 mb-sm-4 t-h2" [serverErrors]="model?.serverErrors?.SerialNumber">
        <h2 class="font-weight-normal" *ngIf="!isEdit || isOriginalDocument">{{ formatSerial(model?.SerialNumber) }}
        </h2>
        <t-serial-editor *ngIf="isEdit && !isOriginalDocument" [(ngModel)]="model.SerialNumber"
            [ngModelOptions]="{ updateOn: 'blur' }" [codeWidth]="codeWidth" [prefix]="serialPrefix" required>
        </t-serial-editor>
    </t-form-group>

    <!-- Posting Date -->
    <t-form-group class="t-form-group" [label]="labelDocumentPostingDate(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="PostingDateIsCommon"
        [disableLabelMenu]="!(isEdit && showDocumentPostingDateIsCommon(model))"
        [serverErrors]="model?.serverErrors?.PostingDate" *ngIf="showDocumentPostingDate(model)">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.PostingDate">
            <div>{{ model?.PostingDate | dateFormat }}</div>
        </t-restricted>
        <t-date-picker *ngIf="isEdit" [disabled]="readonlyDocumentPostingDate(model)"
            [required]="requireDocumentPostingDate(model)" [(ngModel)]="model.PostingDate"
            [ngModelOptions]="{ updateOn: 'blur' }">
        </t-date-picker>
    </t-form-group>

    <!-- Clearance -->
    <t-form-group class="t-form-group" [label]="'Document_Clearance' | translate"
        [serverErrors]="model?.serverErrors?.Clearance" *ngIf="showClearance(model)">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Clearance">
            <div>{{ clearanceDisplay(model?.Clearance) }}</div>
        </t-restricted>
        <t-selector *ngIf="isEdit" [(ngModel)]="model.Clearance" [choices]="clearanceChoices">
        </t-selector>
    </t-form-group>

    <!-- Agent -->
    <t-form-group class="t-form-group" [label]="labelDocumentAgent(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="AgentIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.AgentId"
        *ngIf="showDocumentAgent(model)">
        <ng-container *ngIf="model?.AgentIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.AgentId">
                <t-view-link [link]="'../../../agents/' + ws.get('Agent', model?.AgentId)?.DefinitionId"
                    [itemId]="model?.AgentId">
                    {{ ws.getMultilingualValue('Agent', model?.AgentId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-agents-picker *ngIf="isEdit" [(ngModel)]="model.AgentId"
                [definitionIds]="documentAgentDefinitionIds(model)" [filter]="filterDocumentAgent(model)"
                [required]="requireDocumentAgent(model)" [disabled]="readonlyDocumentAgent(model)">
            </t-agents-picker>
        </ng-container>
    </t-form-group>

    <!-- Resource -->
    <t-form-group class="t-form-group" [label]="labelDocumentResource(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="ResourceIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.ResourceId"
        *ngIf="showDocumentResource(model)">
        <ng-container *ngIf="model?.ResourceIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.ResourceId">
                <t-view-link [link]="'../../../resources/' + ws.get('Resource', model?.ResourceId)?.DefinitionId"
                    [itemId]="model?.ResourceId">
                    {{ ws.getMultilingualValue('Resource', model?.ResourceId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-resources-picker *ngIf="isEdit" [(ngModel)]="model.ResourceId"
                [definitionIds]="documentResourceDefinitionIds(model)" [filter]="filterDocumentResource(model)"
                [required]="requireDocumentResource(model)" [disabled]="readonlyDocumentResource(model)">
            </t-resources-picker>
        </ng-container>
    </t-form-group>

    <!-- NotedAgent -->
    <t-form-group class="t-form-group" [label]="labelDocumentNotedAgent(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="NotedAgentIsCommon" [disableLabelMenu]="!isEdit"
        [serverErrors]="model?.serverErrors?.NotedAgentId" *ngIf="showDocumentNotedAgent(model)">
        <ng-container *ngIf="model?.NotedAgentIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.NotedAgentId">
                <t-view-link [link]="'../../../agents/' + ws.get('Agent', model?.NotedAgentId)?.DefinitionId"
                    [itemId]="model?.NotedAgentId">
                    {{ ws.getMultilingualValue('Agent', model?.NotedAgentId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-agents-picker *ngIf="isEdit" [(ngModel)]="model.NotedAgentId"
                [definitionIds]="documentNotedAgentDefinitionIds(model)" [filter]="filterDocumentNotedAgent(model)"
                [required]="requireDocumentNotedAgent(model)" [disabled]="readonlyDocumentNotedAgent(model)">
            </t-agents-picker>
        </ng-container>
    </t-form-group>

    <!-- NotedResource -->
    <t-form-group class="t-form-group" [label]="labelDocumentNotedResource(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="NotedResourceIsCommon" [disableLabelMenu]="!isEdit"
        [serverErrors]="model?.serverErrors?.NotedResourceId" *ngIf="showDocumentNotedResource(model)">
        <ng-container *ngIf="model?.NotedResourceIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.NotedResourceId">
                <t-view-link [link]="'../../../resources/' + ws.get('Resource', model?.NotedResourceId)?.DefinitionId"
                    [itemId]="model?.NotedResourceId">
                    {{ ws.getMultilingualValue('Resource', model?.NotedResourceId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-resources-picker *ngIf="isEdit" [(ngModel)]="model.NotedResourceId"
                [definitionIds]="documentNotedResourceDefinitionIds(model)"
                [filter]="filterDocumentNotedResource(model)" [required]="requireDocumentNotedResource(model)"
                [disabled]="readonlyDocumentNotedResource(model)">
            </t-resources-picker>
        </ng-container>
    </t-form-group>

    <!-- Center -->
    <t-form-group class="t-form-group" [label]="labelDocumentCenter(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="CenterIsCommon" [disableLabelMenu]="!(isEdit && showDocumentCenterIsCommon(model))"
        [serverErrors]="model?.serverErrors?.CenterId" *ngIf="showDocumentCenter(model)">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.CenterId">
            <t-view-link link="../../../centers" [itemId]="model?.CenterId">
                {{ ws.getMultilingualValue('Center', model?.CenterId, 'Name') }}
            </t-view-link>
        </t-restricted>
        <t-centers-picker *ngIf="isEdit" [(ngModel)]="model.CenterId" [required]="requireDocumentCenter(model)"
            [disabled]="readonlyDocumentCenter(model)" [filter]="filterDocumentCenter(model)">
        </t-centers-picker>
    </t-form-group>

    <!-- Currency -->
    <t-form-group class="t-form-group" [label]="labelDocumentCurrency(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="CurrencyIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.CurrencyId"
        *ngIf="showDocumentCurrency(model)">
        <ng-container *ngIf="model?.CurrencyIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.CurrencyId">
                <t-view-link link="../../../currencies" [itemId]="model?.CurrencyId">
                    {{ ws.getMultilingualValue('Currency', model?.CurrencyId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-currencies-picker *ngIf="isEdit" [(ngModel)]="model.CurrencyId" [filter]="filterDocumentCurrency(model)"
                [required]="requireDocumentCurrency(model)" [disabled]="readonlyDocumentCurrency(model)">
            </t-currencies-picker>
        </ng-container>
    </t-form-group>

    <!-- Quantity -->
    <t-form-group class="t-form-group" [label]="labelDocumentQuantity(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="QuantityIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.Quantity"
        *ngIf="showDocumentQuantity(model)">
        <ng-container *ngIf="model?.QuantityIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Quantity">
                {{ model?.Quantity | accounting:'1.0-4' }}
            </t-restricted>
            <t-decimal-editor *ngIf="isEdit" [(ngModel)]="model.Quantity" [ngModelOptions]="{ updateOn: 'blur' }"
                [minDecimalPlaces]="0" [maxDecimalPlaces]="4" [required]="requireDocumentQuantity(model)"
                [disabled]="readonlyDocumentQuantity(model)">
            </t-decimal-editor>
        </ng-container>
    </t-form-group>

    <!-- Unit -->
    <t-form-group class="t-form-group" [label]="labelDocumentUnit(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="UnitIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.UnitId"
        *ngIf="showDocumentUnit(model)">
        <ng-container *ngIf="model?.UnitIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.UnitId">
                <t-view-link link="../../../units/" [itemId]="model?.UnitId">
                    {{ ws.getMultilingualValue('Unit', model?.UnitId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-units-picker *ngIf="isEdit" [(ngModel)]="model.UnitId" [filter]="filterDocumentUnit(model)"
                [required]="requireDocumentUnit(model)" [disabled]="readonlyDocumentUnit(model)">
            </t-units-picker>
        </ng-container>
    </t-form-group>

    <!-- Time1 -->
    <t-form-group class="t-form-group" [label]="labelDocumentTime1(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="Time1IsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.Time1"
        *ngIf="showDocumentTime1(model)">
        <ng-container *ngIf="model?.Time1IsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Time1">
                {{ model?.Time1 | dateFormat }}
            </t-restricted>
            <t-date-picker *ngIf="isEdit" [(ngModel)]="model.Time1" [ngModelOptions]="{ updateOn: 'blur' }"
                [required]="requireDocumentTime1(model)" [disabled]="readonlyDocumentTime1(model)">
            </t-date-picker>
        </ng-container>
    </t-form-group>

    <!-- Duration -->
    <t-form-group class="t-form-group" [label]="labelDocumentDuration(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="DurationIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.Duration"
        *ngIf="showDocumentDuration(model)">
        <ng-container *ngIf="model?.DurationIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Duration">
                {{ model?.Duration | accounting:'1.0-4' }}
            </t-restricted>
            <t-decimal-editor *ngIf="isEdit" [(ngModel)]="model.Duration" [ngModelOptions]="{ updateOn: 'blur' }"
                [minDecimalPlaces]="0" [maxDecimalPlaces]="4" [required]="requireDocumentDuration(model)"
                [disabled]="readonlyDocumentDuration(model)">
            </t-decimal-editor>
        </ng-container>
    </t-form-group>

    <!-- DurationUnit -->
    <t-form-group class="t-form-group" [label]="labelDocumentDurationUnit(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="DurationUnitIsCommon" [disableLabelMenu]="!isEdit"
        [serverErrors]="model?.serverErrors?.DurationUnitId" *ngIf="showDocumentDurationUnit(model)">
        <ng-container *ngIf="model?.DurationUnitIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.DurationUnitId">
                <t-view-link link="../../../units/" [itemId]="model?.DurationUnitId">
                    {{ ws.getMultilingualValue('Unit', model?.DurationUnitId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-units-picker *ngIf="isEdit" [(ngModel)]="model.DurationUnitId"
                [filter]="filterDocumentDurationUnit(model)" [required]="requireDocumentDurationUnit(model)"
                [disabled]="readonlyDocumentDurationUnit(model)">
            </t-units-picker>
        </ng-container>
    </t-form-group>

    <!-- Time2 -->
    <t-form-group class="t-form-group" [label]="labelDocumentTime2(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="Time2IsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.Time2"
        *ngIf="showDocumentTime2(model)">
        <ng-container *ngIf="model?.Time2IsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Time2">
                {{ model?.Time2 | dateFormat }}
            </t-restricted>
            <t-date-picker *ngIf="isEdit" [(ngModel)]="model.Time2" [ngModelOptions]="{ updateOn: 'blur' }"
                [required]="requireDocumentTime2(model)" [disabled]="readonlyDocumentTime2(model)">
            </t-date-picker>
        </ng-container>
    </t-form-group>

    <!-- NotedDate -->
    <t-form-group class="t-form-group" [label]="labelDocumentNotedDate(model)" [labelContextMenu]="documentIsCommonMenu"
        labelContext="NotedDateIsCommon" [disableLabelMenu]="!isEdit" [serverErrors]="model?.serverErrors?.NotedDate"
        *ngIf="showDocumentNotedDate(model)">
        <ng-container *ngIf="model?.NotedDateIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.NotedDate">
                {{ model?.NotedDate | dateFormat }}
            </t-restricted>
            <t-date-picker *ngIf="isEdit" [(ngModel)]="model.NotedDate" [ngModelOptions]="{ updateOn: 'blur' }"
                [required]="requireDocumentNotedDate(model)" [disabled]="readonlyDocumentNotedDate(model)">
            </t-date-picker>
        </ng-container>
    </t-form-group>

    <!-- ExternalReference -->
    <t-form-group class="t-form-group" [label]="labelDocumentExternalReference(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="ExternalReferenceIsCommon" [disableLabelMenu]="!isEdit"
        [serverErrors]="model?.serverErrors?.ExternalReference" *ngIf="showDocumentExternalReference(model)">
        <ng-container *ngIf="model?.ExternalReferenceIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.ExternalReference">
                {{ model?.ExternalReference }}
            </t-restricted>
            <t-text-editor *ngIf="isEdit" [(ngModel)]="model.ExternalReference" [ngModelOptions]="{ updateOn: 'blur' }"
                [required]="requireDocumentExternalReference(model)"
                [disabled]="readonlyDocumentExternalReference(model)">
            </t-text-editor>
        </ng-container>
    </t-form-group>

    <!-- ReferenceSource -->
    <t-form-group class="t-form-group" [label]="labelDocumentReferenceSource(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="ReferenceSourceIsCommon" [disableLabelMenu]="!isEdit"
        [serverErrors]="model?.serverErrors?.ReferenceSourceId" *ngIf="showDocumentReferenceSource(model)">
        <ng-container *ngIf="model?.ReferenceSourceIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.ReferenceSourceId">
                <t-view-link [link]="'../../../agents/' + ws.get('Agent', model?.ReferenceSourceId)?.DefinitionId"
                    [itemId]="model?.ReferenceSourceId">
                    {{ ws.getMultilingualValue('Agent', model?.ReferenceSourceId, 'Name') }}
                </t-view-link>
            </t-restricted>
            <t-agents-picker *ngIf="isEdit" [(ngModel)]="model.ReferenceSourceId"
                [definitionIds]="documentReferenceSourceDefinitionIds(model)"
                [filter]="filterDocumentReferenceSource(model)" [required]="requireDocumentReferenceSource(model)"
                [disabled]="readonlyDocumentReferenceSource(model)">
            </t-agents-picker>
        </ng-container>
    </t-form-group>

    <!-- InternalReference -->
    <t-form-group class="t-form-group" [label]="labelDocumentInternalReference(model)"
        [labelContextMenu]="documentIsCommonMenu" labelContext="InternalReferenceIsCommon" [disableLabelMenu]="!isEdit"
        [serverErrors]="model?.serverErrors?.InternalReference" *ngIf="showDocumentInternalReference(model)">
        <ng-container *ngIf="model?.InternalReferenceIsCommon; else perTab">
            <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.InternalReference">
                {{ model?.InternalReference }}
            </t-restricted>
            <t-text-editor *ngIf="isEdit" [(ngModel)]="model.InternalReference" [ngModelOptions]="{ updateOn: 'blur' }"
                [required]="requireDocumentInternalReference(model)"
                [disabled]="readonlyDocumentInternalReference(model)">
            </t-text-editor>
        </ng-container>
    </t-form-group>

    <!-- Lookup1 -->
    <t-form-group class="t-form-group" [label]="Lookup1_label" *ngIf="Lookup1_isVisible"
        [serverErrors]="model?.serverErrors?.Lookup1Id">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Lookup1">
            <t-view-link [link]="'../../../lookups/' + ws.get('Lookup', model.Lookup1Id)?.DefinitionId"
                [itemId]="model?.Lookup1Id">
                {{ ws.getMultilingualValue('Lookup', model.Lookup1Id, 'Name') }}
            </t-view-link>
        </t-restricted>
        <t-lookups-picker *ngIf="isEdit" [(ngModel)]="model.Lookup1Id" [definitionId]="Lookup1_DefinitionId"
            [required]="Lookup1_isRequired">
        </t-lookups-picker>
    </t-form-group>

    <!-- Lookup2 -->
    <t-form-group class="t-form-group" [label]="Lookup2_label" *ngIf="Lookup2_isVisible"
        [serverErrors]="model?.serverErrors?.Lookup2Id">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Lookup2">
            <t-view-link [link]="'../../../lookups/' + ws.get('Lookup', model.Lookup2Id)?.DefinitionId"
                [itemId]="model?.Lookup2Id">
                {{ ws.getMultilingualValue('Lookup', model.Lookup2Id, 'Name') }}
            </t-view-link>
        </t-restricted>

        <t-lookups-picker *ngIf="isEdit" [(ngModel)]="model.Lookup2Id" [definitionId]="Lookup2_DefinitionId"
            [required]="Lookup2_isRequired">
        </t-lookups-picker>
    </t-form-group>

    <!-- Document Memo -->
    <t-form-group *ngIf="showDocumentMemo(model)" class="t-form-group" [label]="'Memo' | translate"
        [labelContextMenu]="documentIsCommonMenu" labelContext="MemoIsCommon"
        [disableLabelMenu]="!(isEdit && showDocumentMemoIsCommon(model))" [serverErrors]="model?.serverErrors?.Memo">
        <div *ngIf="!isEdit" [innerHTML]="model?.Memo | linky"></div>
        <t-multiline-editor *ngIf="isEdit" [(ngModel)]="model.Memo" [ngModelOptions]="{ updateOn: 'blur' }"
            [required]="requireDocumentMemo(model)" [disabled]="readonlyDocumentMemo(model)">
        </t-multiline-editor>
    </t-form-group>

    <ng-template #perTab>
        <div class="flex-grow-1" [class.t-disabled-background]="isEdit" [class.border-bottom]="isEdit">
            <span class="font-italic text-muted">{{ '(' + ('SpecifiedPerTab' | translate) + ')' }}</span>
        </div>
    </ng-template>

    <ng-template #perLine>
        <div class="flex-grow-1" [class.t-disabled-background]="isEdit" [class.border-bottom]="isEdit">
            <span class="font-italic text-muted">{{ '(' + ('SpecifiedPerLine' | translate) + ')' }}</span>
        </div>
    </ng-template>

    <!-- Context menu for results -->
    <ng-template #documentIsCommonMenu let-prop let-close="close">
        <div class="dropdown">
            <ul class="dropdown-menu show shadow-sm">
                <li class="dropdown-item px-0 py-1" (click)="onToggleDocumentIsCommon(model, prop); close();">
                    <div class="t-menu-icon">
                        <fa-icon [icon]="model[prop] ? 'expand' : 'compress'"></fa-icon>
                    </div>
                    <div class="t-menu-text">
                        {{ (model[prop] ? 'SpecifyPerTab' : 'SpecifyForAllTabs') | translate }}
                    </div>
                </li>
            </ul>
        </div>
    </ng-template>

    <ul ngbNav #tabs="ngbNav" class="pt-3 pt-sm-4 w-100 nav-tabs" [destroyOnHide]="true"
        [activeId]="getActiveTab(model)" (activeIdChange)="setActiveTab($event)">

        <!-- Smart Tabs -->
        <li *ngFor="let lineDefId of visibleTabs(model)" [ngbNavItem]="lineDefId">
            <a ngbNavLink [style.background-color]="smartTabColor(lineDefId, model)" [tContextMenu]="tabContextMenu"
                [tContext]="lineDefId" [tDisableMenu]="isEdit && showEditLineDefinition()">
                <span *ngIf="showTabErrors(lineDefId, model)" class="text-danger">
                    <fa-icon icon="exclamation">
                    </fa-icon>&nbsp;
                </span>
                <span class="small t-slightly-bold">
                    <span>{{ tabTitle(lineDefId, model) }}</span>
                    <ng-container *ngIf="(!model?.Id ||
                    model?.EntityMetadata?.Lines === 2) && tabCount(lineDefId, model) > 0">&nbsp;&nbsp;<span>({{
                            tabCount(lineDefId, model) | number }})</span>
                    </ng-container>
                </span>
            </a>
            <ng-template ngbNavContent>
                <t-restricted [metadata]="model?.EntityMetadata?.Lines"
                    [class.p-4]="model?.EntityMetadata?.Lines === 1">

                    <!-- Smart Tab -->
                    <ng-template #smartTab>

                        <!-- Form -->
                        <ng-container *ngIf="showAsForm(lineDefId, model); else tableTab">
                            <div class="row m-0 pt-2 t-form" [style.background-color]="formColor(lineDefId, model)">
                                <ng-container *ngIf="lines(lineDefId, model).length > 0; else noFormMessage">
                                    <div class="col-12 d-flex justify-content-end">
                                        <ng-container
                                            *ngTemplateOutlet="smartCommands;context: { item: lines(lineDefId, model)[0], isEdit: isEdit }">
                                        </ng-container>

                                        &nbsp;&nbsp;
                                        <ng-container *ngIf="isEdit">
                                            <div class="h-100 border-left">

                                            </div>
                                            &nbsp;
                                            <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1"
                                                (click)="onDeleteForm(lineDefId, model)">
                                                <fa-icon icon="trash" [title]="'Delete' | translate">
                                                </fa-icon>
                                            </button>
                                            &nbsp;
                                            <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1"
                                                (click)="onCreateForm(lineDefId, model)">
                                                <fa-icon icon="plus" [title]="'AddAnotherSwitchToTable' | translate">
                                                </fa-icon>
                                            </button>
                                        </ng-container>
                                    </div>
                                    <ng-container *ngFor="let colIndex of smartColumnIndices(lineDefId, model)">
                                        <ng-container *ngTemplateOutlet="smartRow; context: { 
                                                    item: lines(lineDefId, model)[0], 
                                                    argument: colIndex, 
                                                    index: 0, 
                                                    update: dummyUpdate, 
                                                    isForm: true }">
                                        </ng-container>
                                    </ng-container>
                                </ng-container>
                                <ng-template #noFormMessage>
                                    <div class="px-3 text-muted font-italic" *ngIf="!isEdit">
                                        {{ 'NotAdded' | translate }}
                                    </div>
                                </ng-template>
                            </div>

                            <div class="col-12 py-1 px-3 d-flex" *ngIf="isEdit">
                                <!-- Add button -->
                                <button *ngIf="lines(lineDefId, model).length === 0" class="btn btn-sm btn-primary"
                                    (click)="onCreateForm(lineDefId, model)">
                                    <fa-icon icon="plus"></fa-icon>&nbsp;&nbsp;{{ 'Add' | translate }}
                                </button>
                            </div>
                        </ng-container>

                        <!-- Table -->
                        <ng-template #tableTab>

                            <!-- Tab Header -->
                            <div *ngIf="showTabHeader(lineDefId, model, isEdit)"
                                class="row m-0 pt-2 pb-3 t-form border-bottom2">
                                <ng-container *ngFor="let columnIndex of smartTabHeaderColumnPaths(lineDefId, model)">
                                    <t-form-group class="t-form-group" [labelContextMenu]="tabIsCommonMenu"
                                        [labelContext]="columnIndex" [disableLabelMenu]="!isEdit"
                                        [serverErrors]="tabHeaderServerErrors(lineDefId, columnIndex, model)"
                                        [label]="columnLabel(lineDefId, columnIndex)">
                                        <ng-container *ngIf="tabIsCommon(lineDefId, columnIndex, model); else perLine">
                                            <ng-container
                                                *ngTemplateOutlet="formGroupContent; context: { columnIndex: columnIndex, update: dummyUpdate, isForm: true }">
                                            </ng-container>
                                        </ng-container>
                                    </t-form-group>
                                </ng-container>

                                <div class="w-100"></div>

                                <!-- Barcode scanner -->
                                <t-form-group *ngIf="showBarcodeField(lineDefId, isEdit)" class="t-form-group">
                                    <t-text-editor [ngModel]="getBarcode(lineDefId, model)"
                                        (ngModelChange)="setBarcode(lineDefId, model, $event)"
                                        [placeholder]="barcodeFieldPlaceholder(lineDefId)"
                                        (enter)="onBarcodeEnter(lineDefId, model, tableComponent)">
                                    </t-text-editor>
                                </t-form-group>
                                <div class="t-form-group" *ngIf="isBarcodeLoading(lineDefId, model)">
                                    <t-spinner></t-spinner>
                                </div>
                                <div class="w-100 pt-3" *ngIf="showBarcodeError(lineDefId, model)">
                                    <t-error-message dismissable="true" (dismiss)="clearBarcodeError()">
                                        {{ getBarcodeError(lineDefId, model) }} </t-error-message>
                                </div>
                            </div>

                            <!-- Smart Table -->
                            <t-table #tableComponent [dataSource]="lines(lineDefId, model)" [isEdit]="isEdit"
                                [columnPaths]="smartColumnPathsForTable(lineDefId, model)"
                                [headerTemplate]="smartHeader" [rowTemplate]="smartRow"
                                [columnTemplates]="columnTemplates(lineDefId)" [toolbar]="smartHeaderCommands"
                                [commands]="smartCommands" [onNewItem]="onNewSmartLineFactory(lineDefId)"
                                (insert)="onInsertSmartLine($event, model)" (delete)="onDeleteSmartLine($event, model)"
                                [highlightFunc]="highlightLineFactory(model)" [attentionItem]="attentionItem"
                                [isSearchResult]="isSearchResultFactory(model)">
                            </t-table>

                            <!-- Totals -->
                            <div class="d-flex justify-content-end mt-3"
                                *ngIf=" smartTotalsColumnIndices(lineDefId, model, isEdit).length > 0">
                                <table class="border-top border-bottom py-1">
                                    <tr>
                                        <td class="p-1" colspan="10"></td>
                                    </tr>
                                    <tr *ngFor="let columnIndex of smartTotalsColumnIndices(lineDefId, model, isEdit)">
                                        <td style="width: 20px;"></td>
                                        <td class="small font-weight-bold">
                                            {{ ('Total0' | translate:{ '0': columnLabel(lineDefId, columnIndex) })
                                            }}&nbsp;&nbsp;&nbsp;
                                        </td>
                                        <td style="text-align: right">
                                            {{ smartTotal(lineDefId, columnIndex, model) | accounting:functional_format
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-1" colspan="10"></td>
                                    </tr>
                                </table>
                            </div>
                        </ng-template>

                    </ng-template>

                    <!-- Manual Tab -->
                    <ng-container *ngIf="isManualLine(lineDefId); else smartTab">
                        <ng-container *ngTemplateOutlet="manualLines">
                        </ng-container>

                        <!-- Totals -->
                        <div class="d-flex justify-content-end mt-3">
                            <table class="border-top border-bottom">
                                <tr>
                                    <td style="width: 20px;"></td>
                                    <td class="small font-weight-bold pb-12 pt-2">
                                        {{ ('Total0' | translate:{ '0': ('Debit' | translate) }) + functionalPostfix
                                        }}&nbsp;&nbsp;&nbsp;
                                    </td>
                                    <td class="px-1 pt-2" style="text-align: right">
                                        {{ total(model, 1, true) | accounting:functional_format }}
                                    </td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td class="small font-weight-bold pt-12 pb-2">
                                        {{ ('Total0' | translate:{ '0': ('Credit' | translate) }) + functionalPostfix
                                        }}&nbsp;&nbsp;&nbsp;
                                    </td>
                                    <td class="px-1 pb-2 align-right" style="text-align: right;">
                                        {{ total(model, -1, true) | accounting:functional_format }}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </ng-container>
                </t-restricted>

                <!----------- Smart Lines ----------->
                <ng-template #smartHeader let-columnIndex="argument">
                    <div [style.text-align]="columnLabelAlignment(lineDefId, columnIndex)"
                        [style.min-width.px]="isEdit ? 120 : 0">
                        {{ columnLabel(lineDefId, columnIndex) }}&nbsp;&nbsp;</div>
                </ng-template>

                <ng-template #smartRow let-line="item" let-columnIndex="argument" let-rowIndex="index"
                    let-update="update" let-isForm="isForm" let-isEdit="isEdit">
                    <t-form-group-cell *ngIf="!isForm" class="t-form-group"
                        [serverErrors]="lineEntryServerErrors(lineDefId, columnIndex, line)">
                        <ng-container
                            *ngTemplateOutlet="formGroupContent; context: { columnIndex: columnIndex, rowIndex: rowIndex, line: line, update: update, isForm: isForm }">
                        </ng-container>
                    </t-form-group-cell>
                    <t-form-group *ngIf="isForm" class="t-form-group"
                        [serverErrors]="lineEntryServerErrors(lineDefId, columnIndex, line)"
                        [label]="columnLabel(lineDefId, columnIndex)">
                        <ng-container
                            *ngTemplateOutlet="formGroupContent; context: { columnIndex: columnIndex, rowIndex: rowIndex, line: line, update: update, isForm: isForm }">
                        </ng-container>
                    </t-form-group>
                </ng-template>

                <ng-template #formGroupContent let-columnIndex="columnIndex" let-rowIndex="rowIndex" let-update="update"
                    let-line="line" let-isForm="isForm">

                    <!-- View Mode -->
                    <ng-container *ngIf="!isEdit; else editMode" [ngSwitch]="columnName(lineDefId, columnIndex)">
                        <t-view-link *ngSwitchCase="'AccountId'" link="../../../accounts"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ accountDisplay(getFieldValue(lineDefId, columnIndex, line, model)) }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'CurrencyId'" link="../../../currencies"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Currency', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'AgentId'"
                            [link]="'../../../agents/' + ws.get('Agent', getFieldValue(lineDefId, columnIndex, line, model))?.DefinitionId"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'ResourceId'"
                            [link]="'../../../resources/' + ws.get('Resource', getFieldValue(lineDefId, columnIndex, line, model))?.DefinitionId"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Resource', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'NotedAgentId'"
                            [link]="'../../../agents/' + ws.get('Agent', getFieldValue(lineDefId, columnIndex, line, model))?.DefinitionId"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'NotedResourceId'"
                            [link]="'../../../resources/' + ws.get('Resource', getFieldValue(lineDefId, columnIndex, line, model))?.DefinitionId"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Resource', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'CenterId'" link="../../../centers"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Center', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <t-view-link *ngSwitchCase="'EntryTypeId'" link="../../../entry-types"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('EntryType', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <div *ngSwitchCase="'MonetaryValue'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                accounting:MonetaryValue_format(entry(lineDefId, columnIndex, line)) }}</span>
                        </div>
                        <div *ngSwitchCase="'Quantity'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) | accounting:'1.0-4' }}</span>
                        </div>
                        <span *ngSwitchCase="'UnitId'">{{ ws.getMultilingualValue('Unit', getFieldValue(lineDefId,
                            columnIndex, line, model), 'Name') }}</span>
                        <div *ngSwitchCase="'Value'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) | accounting:functional_format
                                }}</span>
                        </div>
                        <span *ngSwitchCase="'Time1'">{{ getFieldValue(lineDefId, columnIndex, line, model) | dateFormat
                            }}</span>

                        <div *ngSwitchCase="'Duration'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) | accounting:'1.0-4' }}</span>
                        </div>

                        <t-view-link *ngSwitchCase="'DurationUnitId'" link="../../../units"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Unit', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>

                        <span *ngSwitchCase="'Time2'">{{ getFieldValue(lineDefId, columnIndex, line, model) | dateFormat
                            }}</span>
                        <span *ngSwitchCase="'ExternalReference'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                            }}</span>
                        <t-view-link *ngSwitchCase="'ReferenceSourceId'"
                            [link]="'../../../agents/' + ws.get('Agent', getFieldValue(lineDefId, columnIndex, line, model))?.DefinitionId"
                            [itemId]="getFieldValue(lineDefId, columnIndex, line, model)">
                            {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line, model),
                            'Name') }}
                        </t-view-link>
                        <span *ngSwitchCase="'InternalReference'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                            }}</span>
                        <span *ngSwitchCase="'NotedAgentName'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                            }}</span>
                        <div *ngSwitchCase="'NotedAmount'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                accounting:MonetaryValue_format(entry(lineDefId, columnIndex, line)) }}</span>
                        </div>
                        <span *ngSwitchCase="'NotedDate'">{{ getFieldValue(lineDefId, columnIndex, line, model) |
                            dateFormat }}</span>
                        <span *ngSwitchCase="'Memo'">{{ getFieldValue(lineDefId, columnIndex, line, model) }}</span>
                        <span *ngSwitchCase="'Boolean1'">{{ (getFieldValue(lineDefId, columnIndex, line, model) ? 'Yes'
                            :
                            'No') | translate }}</span>

                        <div *ngSwitchCase="'Decimal1'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                accounting:'1.0-4' }}</span>
                        </div>
                        <div *ngSwitchCase="'Decimal2'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                accounting:'1.0-4' }}</span>
                        </div>
                        <div *ngSwitchCase="'2'" class="t-right-aligned">
                            <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                accounting:'1.0-4' }}</span>
                        </div>
                        <span *ngSwitchCase="'Text1'">{{ getFieldValue(lineDefId, columnIndex, line, model) }}</span>
                        <span *ngSwitchCase="'Text2'">{{ getFieldValue(lineDefId, columnIndex, line, model) }}</span>
                        <span *ngSwitchCase="'PostingDate'">{{ getFieldValue(lineDefId, columnIndex, line, model) |
                            dateFormat }}</span>
                        <span *ngSwitchDefault>{{ getFieldValue(lineDefId, columnIndex, line, model) }}</span>
                    </ng-container>
                    <ng-template #editMode>
                        <!-- Edit Mode: Readonly Field -->
                        <ng-container
                            *ngIf="isReadOnly(lineDefId, columnIndex, line, model); else editableFormGroupContent">
                            <div class="w-100 t-disabled-background border-bottom"
                                [ngSwitch]="columnName(lineDefId, columnIndex)">
                                <span *ngSwitchCase="'AccountId'">
                                    {{ accountDisplay(getFieldValue(lineDefId, columnIndex, line, model)) }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'CurrencyId'">
                                    {{ ws.getMultilingualValue('Currency', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'AgentId'">
                                    {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'ResourceId'">
                                    {{ ws.getMultilingualValue('Resource', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'NotedAgentId'">
                                    {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'NotedResourceId'">
                                    {{ ws.getMultilingualValue('Resource', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'CenterId'">
                                    {{ ws.getMultilingualValue('Center', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'EntryTypeId'">
                                    {{ ws.getMultilingualValue('EntryType', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <div *ngSwitchCase="'MonetaryValue'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                        accounting:MonetaryValue_format(entry(lineDefId, columnIndex, line))
                                        }}&zwnj;</span>
                                </div>
                                <div *ngSwitchCase="'Quantity'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) | accounting:'1.0-4'
                                        }}&zwnj;</span>
                                </div>
                                <span *ngSwitchCase="'UnitId'">{{ ws.getMultilingualValue('Unit',
                                    getFieldValue(lineDefId, columnIndex, line, model), 'Name') }}&zwnj;</span>
                                <div *ngSwitchCase="'Value'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                        accounting:functional_format }}&zwnj;</span>
                                </div>
                                <span *ngSwitchCase="'Time1'">{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                    dateFormat }}&zwnj;</span>
                                <div *ngSwitchCase="'Duration'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) | accounting:'1.0-4'
                                        }}&zwnj;</span>
                                </div>
                                <span *ngSwitchCase="'DurationUnitId'">{{ ws.getMultilingualValue('Unit',
                                    getFieldValue(lineDefId, columnIndex, line, model), 'Name') }}&zwnj;</span>
                                <span *ngSwitchCase="'Time2'">{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                    dateFormat }}&zwnj;</span>
                                <span *ngSwitchCase="'ExternalReference'">{{ getFieldValue(lineDefId, columnIndex, line,
                                    model) }}&zwnj;</span>
                                <span *ngSwitchCase="'ReferenceSourceId'">
                                    {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line,
                                    model), 'Name') }}&zwnj;
                                </span>
                                <span *ngSwitchCase="'InternalReference'">{{ getFieldValue(lineDefId, columnIndex, line,
                                    model) }}&zwnj;</span>
                                <span *ngSwitchCase="'NotedAgentName'">{{ getFieldValue(lineDefId, columnIndex, line,
                                    model) }}&zwnj;</span>
                                <div *ngSwitchCase="'NotedAmount'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                        accounting:MonetaryValue_format(entry(lineDefId, columnIndex, line))
                                        }}&zwnj;</span>
                                </div>
                                <span *ngSwitchCase="'NotedDate'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                                    | dateFormat }}&zwnj;</span>
                                <span *ngSwitchCase="'Memo'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                                    }}&zwnj;</span>
                                <span *ngSwitchCase="'Boolean1'">{{ getFieldValue(lineDefId, columnIndex, line, model) ?
                                    'Yes' : 'No' | translate }}&zwnj;</span>
                                <div *ngSwitchCase="'Decimal1'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                        accounting:'1.0-4' }}&zwnj;</span>
                                </div>
                                <div *ngSwitchCase="'Decimal2'" class="t-right-aligned">
                                    <span>{{ getFieldValue(lineDefId, columnIndex, line, model) |
                                        accounting:'1.0-4' }}&zwnj;</span>
                                </div>
                                <span *ngSwitchCase="'Text1'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                                    }}&zwnj;</span>
                                <span *ngSwitchCase="'Text2'">{{ getFieldValue(lineDefId, columnIndex, line, model)
                                    }}&zwnj;</span>
                                <span *ngSwitchCase="'PostingDate'">{{ getFieldValue(lineDefId, columnIndex, line,
                                    model) | dateFormat }}&zwnj;</span>
                                <span *ngSwitchDefault>{{ getFieldValue(lineDefId, columnIndex, line, model)
                                    }}&zwnj;</span>
                            </div>
                        </ng-container>

                        <!-- Edit Mode: Editable Field -->
                        <ng-template #editableFormGroupContent>
                            <ng-container [ngSwitch]="columnName(lineDefId, columnIndex)">
                                <t-accounts-picker *ngSwitchCase="'AccountId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)" additionalSelect="CurrencyId"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-accounts-picker>
                                <t-currencies-picker *ngSwitchCase="'CurrencyId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)" additionalSelect="E"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-currencies-picker>
                                <t-agents-picker *ngSwitchCase="'AgentId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [definitionIds]="definitionIdsAgent_Smart(lineDefId, columnIndex)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    [additionalSelect]="additionalSelectAgent_Smart(lineDefId)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-agents-picker>
                                <t-resources-picker *ngSwitchCase="'ResourceId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [definitionIds]="definitionIdsResource_Smart(lineDefId, columnIndex)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    [additionalSelect]="additionalSelectResource_Smart(lineDefId)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-resources-picker>
                                <t-agents-picker *ngSwitchCase="'NotedAgentId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [definitionIds]="definitionIdsNotedAgent_Smart(lineDefId, columnIndex)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    [additionalSelect]="additionalSelectNotedAgent_Smart(lineDefId)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-agents-picker>
                                <t-resources-picker *ngSwitchCase="'NotedResourceId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [definitionIds]="definitionIdsNotedResource_Smart(lineDefId, columnIndex)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    [additionalSelect]="additionalSelectNotedResource_Smart(lineDefId)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-resources-picker>
                                <t-centers-picker *ngSwitchCase="'CenterId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-centers-picker>
                                <t-entry-types-picker *ngSwitchCase="'EntryTypeId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [filter]="entryTypeFilter(lineDefId, columnIndex)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-entry-types-picker>
                                <t-decimal-editor *ngSwitchCase="'MonetaryValue'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }"
                                    [minDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                    [maxDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                    [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-decimal-editor *ngSwitchCase="'Quantity'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="0"
                                    [maxDecimalPlaces]="4" [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-units-picker *ngSwitchCase="'UnitId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-units-picker>
                                <t-decimal-editor *ngSwitchCase="'Value'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="functional_decimals"
                                    [maxDecimalPlaces]="functional_decimals" [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-date-picker *ngSwitchCase="'Time1'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-date-picker>
                                <t-decimal-editor *ngSwitchCase="'Duration'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="0"
                                    [maxDecimalPlaces]="4" [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-units-picker *ngSwitchCase="'DurationUnitId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-units-picker>
                                <t-date-picker *ngSwitchCase="'Time2'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-date-picker>
                                <t-text-editor *ngSwitchCase="'ExternalReference'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-text-editor>
                                <t-agents-picker *ngSwitchCase="'ReferenceSourceId'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [definitionIds]="definitionIdsReferenceSource_Smart(lineDefId, columnIndex)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    [filter]="getFilter(lineDefId, columnIndex)"
                                    [additionalSelect]="additionalSelectReferenceSource_Smart(lineDefId)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);">
                                </t-agents-picker>
                                <t-text-editor *ngSwitchCase="'InternalReference'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-text-editor>
                                <t-text-editor *ngSwitchCase="'NotedAgentName'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-text-editor>
                                <t-decimal-editor *ngSwitchCase="'NotedAmount'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }"
                                    [minDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                    [maxDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                    [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-date-picker *ngSwitchCase="'NotedDate'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-date-picker>
                                <t-text-editor *ngSwitchCase="'Memo'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-text-editor>
                                <div *ngSwitchCase="'Boolean1'"
                                    class="custom-control custom-checkbox t-labelless-checkbox">
                                    <input type="checkbox" class="custom-control-input"
                                        [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                        (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                        [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                        id="standardandpure{{ rowIndex }}">
                                    <label class="custom-control-label t-pointer"
                                        for="standardandpure{{ rowIndex }}">&zwnj;</label>
                                </div>
                                <t-decimal-editor *ngSwitchCase="'Decimal1'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="0"
                                    [maxDecimalPlaces]="4" [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-decimal-editor *ngSwitchCase="'Decimal2'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="0"
                                    [maxDecimalPlaces]="4" [textAlignment]="isForm ? null : 'right'">
                                </t-decimal-editor>
                                <t-text-editor *ngSwitchCase="'Text1'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-text-editor>
                                <t-text-editor *ngSwitchCase="'Text2'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-text-editor>
                                <t-date-picker *ngSwitchCase="'PostingDate'"
                                    [required]="!(line && line.PH) && isRequired(lineDefId, columnIndex, line, model)"
                                    [ngModel]="getFieldValue(lineDefId, columnIndex, line, model)"
                                    (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, model, $event); onSmartLineUpdated(update, line, model);"
                                    [ngModelOptions]="{ updateOn: 'blur' }">
                                </t-date-picker>
                            </ng-container>
                        </ng-template>
                    </ng-template>
                </ng-template>

                <!----------- Signatures ------------>
                <div class="row mx-0"
                    *ngIf="!isEdit && requiredSignaturesForLineDef(model, lineDefId, extras)?.length > 0">
                    <div class="col-12 mt-3">
                        <span class="small font-weight-bold">{{ 'SignaturesAndStamps' | translate }}</span>
                    </div>
                    <div class="col-12 col-lg-6 px-2 px-lg-5 mt-3 mb-1"
                        *ngFor="let signature of requiredSignaturesForLineDef(model, lineDefId, extras)">
                        <div class="border-bottom d-flex align-items-stretch p-2 bg-light">

                            <!-- just to keep the height when the parent div is empty-->
                            <div style="height: 37px;"></div>

                            <!-- Signature exists -->
                            <ng-container *ngIf="!!signature.SignedById">
                                <!-- Profile Picture -->
                                <div class="d-flex align-items-center justify-content">
                                    <t-image [src]="'users/' + signature.SignedById + '/image'"
                                        [imageId]="ws.get('User', signature.SignedById)?.ImageId" [size]="36"
                                        shape="circle">
                                    </t-image>
                                </div>
                                <!-- User Name -->
                                <div class="p-2 flex-grow-1 text-truncate d-flex align-items-center">
                                    <span>
                                        <t-view-link link="../../../users" [itemId]="signature.SignedById">
                                            {{ ws.getMultilingualValue('User', signature.SignedById, 'Name') }}
                                        </t-view-link>
                                        <span
                                            *ngIf="!!signature.OnBehalfOfUserId && signature.SignedById !== signature.OnBehalfOfUserId">
                                            {{ 'OnBehalfOf' | translate }}<t-view-link link="../../../users"
                                                [itemId]="signature.OnBehalfOfUserId">
                                                {{ ws.getMultilingualValue('User', signature.OnBehalfOfUserId, 'Name')
                                                }}
                                            </t-view-link></span>
                                    </span>
                                </div>
                                <!-- Stamp -->
                                <div class="d-flex align-items-center" [class.text-success]="signature.ToState > 0"
                                    [class.text-danger]="signature.ToState < 0">
                                    <div class="px-1 font-weight-bold t-large"
                                        [class.t-positive-stamp]="signature.ToState > 0"
                                        [class.t-negative-stamp]="signature.ToState < 0">
                                        <span>{{ actionDisplay(signature.ToState) }}</span>
                                    </div>
                                </div>
                                <!-- Reason if any -->
                                <ng-container *ngIf="!!signature.ReasonDetails || !!signature.ReasonId">
                                    &nbsp;&nbsp;
                                    <div class="text-danger small align-items-center" style="max-width: 120px;">
                                        <div *ngIf="!!signature.ReasonId">
                                            <span class="font-weight-bold">{{ 'Signature_Reason' | translate
                                                }}:&nbsp;</span>
                                            <span>{{ reasonDisplay(lineDefId, signature.ReasonId) }}</span>
                                        </div>

                                        <div *ngIf="!!signature.ReasonDetails">
                                            <span class="font-weight-bold">{{ 'Signature_ReasonDetails' | translate
                                                }}:&nbsp;</span>
                                            <span>{{ signature.ReasonDetails }}</span>
                                        </div>
                                    </div>
                                </ng-container>
                            </ng-container>

                            <!-- No signature but can sign -->
                            <ng-container
                                *ngIf="!signature.SignedById && (signature.CanSign || signature.CanSignOnBehalf)">
                                <div class="w-50 px-1" placement="bottom"
                                    [ngbTooltip]="signTooltip(signature, lineDefId, model)" container="body">
                                    <button class="btn btn-danger px-2 w-100 h-100"
                                        (click)="onSignNo(lineDefId, signature)"
                                        [disabled]="disableSign(signature, lineDefId, model)">
                                        <fa-icon [icon]="negativeActionIcon(signature.ToState)"></fa-icon>
                                        <span>&nbsp;&nbsp;{{ negativeActionDisplay(signature.ToState) }}</span>
                                    </button>
                                </div>
                                <div class="w-50 px-1" placement="bottom"
                                    [ngbTooltip]="signTooltip(signature, lineDefId, model)" container="body">
                                    <button class="btn btn-success px-2 w-100 h-100" (click)="onSignYes(signature)"
                                        [disabled]="disableSign(signature, lineDefId, model)">
                                        <fa-icon [icon]="positiveActionIcon(signature.ToState)"></fa-icon>
                                        <span>&nbsp;&nbsp;{{ positiveActionDisplay(signature.ToState) }}</span>
                                    </button>
                                </div>
                                <div *ngIf="!signature.CanSign && !!signature.OnBehalfOfUserId">
                                    <span>
                                        {{ 'OnBehalfOf' | translate }}<t-view-link link="../../../users"
                                            [itemId]="signature.OnBehalfOfUserId">
                                            {{ ws.getMultilingualValue('User', signature.OnBehalfOfUserId, 'Name') }}
                                        </t-view-link></span>
                                </div>
                            </ng-container>

                            <!-- No signature and cannot sign -->
                            <ng-container
                                *ngIf="!signature.SignedById && !(signature.CanSign || signature.CanSignOnBehalf)">

                            </ng-container>
                        </div>

                        <!-- Footer: type of signature and signing time -->
                        <div class="px-2 small p-1 d-flex justify-content-between">
                            <div class="text-truncate">
                                <span>
                                    <!-- Action -->
                                    <span *ngIf="signature.RuleType !== 'Public'">{{ requiredSignatureDisplay(signature)
                                        }}&nbsp;</span>
                                    <span *ngIf="signature.RuleType === 'Public'">{{ requiredSignatoryDisplay(signature)
                                        }}</span>

                                    <!-- Who's signing -->
                                    <t-view-link *ngIf="signature.RuleType === 'ByRole'" link="../../../roles"
                                        [itemId]="signature.RoleId">
                                        <span>{{ ws.getMultilingualValue('Role', signature.RoleId, 'Name') }}</span>
                                    </t-view-link>
                                    <t-view-link *ngIf="signature.RuleType === 'ByCustodian'"
                                        [link]="'../../../agents/' + ws.get('Agent', signature.CustodianId)?.DefinitionId"
                                        [itemId]="signature.CustodianId">
                                        <span>{{ ws.getMultilingualValue('Agent', signature.CustodianId, 'Name')
                                            }}</span>
                                    </t-view-link>
                                    <t-view-link *ngIf="signature.RuleType === 'ByUser'" link="../../../users"
                                        [itemId]="signature.UserId">
                                        <span>{{ ws.getMultilingualValue('User', signature.UserId, 'Name') }}</span>
                                    </t-view-link>

                                    <!-- # of lines -->
                                    <span *ngIf="lineIds(signature).length !== lines(lineDefId, model).length">&nbsp;{{
                                        '- ' + ('Count0Lines' | translate: { '0': (lineIds(signature).length | number)
                                        }) }}</span>
                                </span>
                            </div>
                            <div>
                                <span class="text-muted" *ngIf="signature.SignedAt">
                                    &nbsp;{{ signature.SignedAt | datetimeFormat }}
                                </span>
                                <div class="d-inline" placement="bottom" [ngbTooltip]="unsignTooltip(signature, model)"
                                    container="body">
                                    <button
                                        class="btn btn-sm btn-light text-primary t-white-button btn-sm h-100 py-0 px-1"
                                        (click)="onUnsign(signature)" *ngIf="canUnsign(signature)"
                                        style="margin-top:-4px"
                                        [title]="disableUnsign(signature, model) ? '' : ('Delete' | translate)"
                                        [disabled]="disableUnsign(signature, model)">
                                        <fa-icon icon="trash"></fa-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>

            <!-- Commands for Smart table -->
            <ng-template #smartHeaderCommands>
                <ng-container *ngIf="isEdit">
                    <button class="btn btn-sm btn-light text-primary t-white-button t-toolbar-button"
                        *ngIf="showAutoGenerate(lineDefId, isEdit)" (click)="onAutoGenerate(lineDefId, model, isEdit)">
                        <fa-icon icon="bolt"></fa-icon>
                        <span class="d-none d-md-inline">&nbsp;&nbsp;{{ autoGenerateLabel(lineDefId) }}</span>
                    </button>

                    <div ngbDropdown [placement]="actionsDropdownPlacement">
                        <button class="btn btn-sm btn-light text-primary t-white-button t-toolbar-button"
                            ngbDropdownToggle>
                            {{ 'Actions' | translate }}</button>
                        <div ngbDropdownMenu>
                            <button ngbDropdownItem class="t-transparent-background"
                                (click)="onDeleteAll(lineDefId, model, isEdit)">
                                {{ 'DeleteAll' | translate }}
                            </button>
                            <button ngbDropdownItem class="t-transparent-background" (click)="linesFileInput.click()">
                                {{ 'ImportLines' | translate }}
                            </button>
                            <button ngbDropdownItem class="t-transparent-background"
                                (click)="onExportTemplateForLines(lineDefId)">
                                {{ 'ExportLineTemplate' | translate }}
                            </button>
                            <!-- <button ngbDropdownItem class="t-transparent-background"
                                *ngIf="showAutoGenerate(lineDefId, isEdit)"
                                (click)="onAutoGenerate(lineDefId, model, isEdit)">
                                {{ autoGenerateLabel(lineDefId) }}
                            </button> -->
                        </div>
                    </div>
                </ng-container>
            </ng-template>


            <!-- for the file dialog -->
            <input type="file" class="d-none" #linesFileInput
                (change)="onParseLines(linesFileInput, lineDefId, model, isEdit)"
                accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />

            <!-- Is Common context menu for tab headers -->
            <ng-template #tabIsCommonMenu let-columnIndex let-close="close">
                <div class="dropdown">
                    <ul class="dropdown-menu show shadow-sm">
                        <li class="dropdown-item px-0 py-1"
                            (click)="onToggleTabIsCommon(lineDefId, columnIndex, model); close();">
                            <div class="t-menu-icon">
                                <fa-icon [icon]="tabIsCommon(lineDefId, columnIndex, model) ? 'expand' : 'compress'">
                                </fa-icon>
                            </div>
                            <div class="t-menu-text">
                                {{ (tabIsCommon(lineDefId, columnIndex, model) ? 'SpecifyPerLine' :
                                'SpecifyForAllLines') | translate }}
                            </div>
                        </li>
                    </ul>
                </div>
            </ng-template>
        </li>

        <!-- Tab context menu -->
        <ng-template #tabContextMenu let-lineDefId let-close="close">
            <div class="dropdown">
                <ul class="dropdown-menu show shadow-sm">
                    <li class="dropdown-item px-0 py-1" (click)="onEditLineDefinition(lineDefId); close();">
                        <div class="t-menu-icon">
                            <fa-icon icon="pen"></fa-icon>
                        </div>
                        <div class="t-menu-text">
                            {{ 'EditDefinition' | translate }}
                        </div>
                    </li>
                </ul>
            </div>
        </ng-template>

        <!-- The dropdown menu for smart lines -->
        <ng-template #smartCommands let-line="item" let-isEdit="isEdit">
            <div ngbDropdown [placement]="commandsDropdownPlacement" *ngIf="!line.PH">
                <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1 t-no-arrow align-baseline"
                    ngbDropdownToggle tabindex="-1"><span class="small">
                        <fa-icon icon="ellipsis-v"></fa-icon>
                    </span></button>
                <div ngbDropdownMenu>
                    <button ngbDropdownItem class="t-transparent-background" (click)="toggleHighlight(line, model)">
                        {{ (isHighlighted(line, model) ? 'RemoveHighlight' : 'AddHighlight') | translate }}
                    </button>
                    <button *ngIf="isEdit" ngbDropdownItem class="t-transparent-background"
                        (click)="onCloneSmartLine(line, model, isEdit)">
                        {{ 'Clone' | translate }}
                    </button>
                </div>
            </div>
        </ng-template>

        <!-- Hidden Tabs Dropdown -->
        <li ngbDropdown *ngIf="isEdit && invisibleTabs(model).length > 0">
            <a href (click)="false" class="nav-link t-no-arrow" ngbDropdownToggle><span class="small t-slightly-bold">
                    <fa-icon icon="ellipsis-h"></fa-icon>
                </span></a>
            <div ngbDropdownMenu>
                <button class="t-transparent-background" *ngFor="let lineDefId of invisibleTabs(model)" ngbDropdownItem
                    (click)="onOtherTab(lineDefId, model)">{{ tabTitle(lineDefId, model) }}</button>
            </div>
        </li>

        <!-- Bookkeeping Tab -->
        <li class="{{ attachmentsClass }}" [ngbNavItem]="-10" *ngIf="showBookkeepingTab">
            <a class="px-2" ngbNavLink [title]="'Bookkeeping' | translate"
                [style.background-color]="bookkeepingTabColor(model)">
                <span class="small t-slightly-bold">
                    <fa-icon icon="book"></fa-icon>
                    <span *ngIf="entriesCount(model) > 0">&nbsp;&nbsp;{{ (!model?.Id || model?.EntityMetadata?.Lines ===
                        2 ? '(' + (entriesCount(model)
                        | number) + ')' : '')}}</span>
                </span>
            </a>
            <ng-template ngbNavContent>
                <t-restricted [metadata]="model?.EntityMetadata?.Lines"
                    [class.p-4]="model?.EntityMetadata?.Lines === 1">
                    <div class="col-12 mt-3 pb-2 border-bottom">
                        <h5 class="small2 font-weight-bold2">
                            {{ ('SmartEntries' | translate) + ' (' + smartEntries(model).length + ')' }}</h5>
                    </div>
                    <t-table [dataSource]="smartEntries(model)" [itemSize]="70" [visibleRows]="5"
                        [highlightFunc]="highlightPairFactory(model)" [columnPaths]="manualColumnPaths(model, true)"
                        [columnTemplates]="{
                                'AccountId' : { headerTemplate : header_Account, rowTemplate : row_Account, weight : 3, argument: true },
                                'Debit' : { headerTemplate : header_Debit, rowTemplate : row_Debit, weight : 1, argument: true },
                                'Credit' : { headerTemplate : header_Credit, rowTemplate : row_Credit, weight : 1, argument: true },
                                'Center' : { headerTemplate : header_Center, rowTemplate : row_Center, weight : 1, argument: true },
                                'Memo' : { headerTemplate : header_Memo, rowTemplate : row_Memo, weight : 2, argument: true },
                                'ModifiedWarning' : { rowTemplate : row_ModifiedWarning },
                                'Commands' : { rowTemplate : row_SmartEntryCommands }
                            }">
                    </t-table>

                    <ng-container *ngIf="hasManualLines">
                        <div class="col-12 mt-3 pb-2 border-bottom">
                            <h5 class="small2 font-weight-bold2">
                                {{ (bookkeepingManualAdjustmentsTitle(model)) + ' (' + manualEntries(model).length + ')'
                                }}
                            </h5>
                        </div>
                        <ng-container *ngTemplateOutlet="manualLines">

                        </ng-container>
                    </ng-container>

                    <!-- Totals -->
                    <div class="d-flex justify-content-end mt-3">
                        <table class="border-top border-bottom">
                            <tr>
                                <td style="width: 20px;"></td>
                                <td class="small font-weight-bold pb-12 pt-2">
                                    {{ ('Total0' | translate:{ '0': ('Debit' | translate) }) + functionalPostfix
                                    }}&nbsp;&nbsp;&nbsp;
                                </td>
                                <td class="px-1 pt-2" style="text-align: right">
                                    {{ total(model, 1) | accounting:functional_format }}
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td class="small font-weight-bold pt-12 pb-2">
                                    {{ ('Total0' | translate:{ '0': ('Credit' | translate) }) + functionalPostfix
                                    }}&nbsp;&nbsp;&nbsp;
                                </td>
                                <td class="px-1 pb-2 align-right" style="text-align: right;">
                                    {{ total(model, -1) | accounting:functional_format }}
                                </td>
                            </tr>
                        </table>
                    </div>
                </t-restricted>
            </ng-template>
        </li>

        <!-- Attachments -->
        <li class="{{ !showBookkeepingTab ? attachmentsClass : '' }}" [ngbNavItem]="-20" *ngIf="showAttachmentsTab">
            <a class="px-2" ngbNavLink><span class="small t-slightly-bold" [title]="'Document_Attachments' | translate">
                    <span *ngIf="showAttachmentsErrors(model)" class="text-danger">
                        <fa-icon icon="exclamation">
                        </fa-icon>&nbsp;
                    </span>
                    <span>
                        <fa-icon icon="paperclip"></fa-icon>
                        <span *ngIf="model?.Attachments?.length > 0">&nbsp;&nbsp;{{ (!model?.Id ||
                            model?.EntityMetadata?.Attachments === 2 ? '(' +
                            (model?.Attachments?.length | number) + ')' : '')}}</span>
                    </span>
                </span>
            </a>
            <ng-template ngbNavContent>
                <!-- No Attachments Message -->
                <div class="p-3 font-italic font-weight-light2 text-muted"
                    *ngIf="!model?.Attachments?.length && !isEdit">
                    <span>{{ 'NoItemsFound' | translate }}</span>
                </div>

                <!-- Attachments List -->
                <div class="w-100 mx-0 mb-1 p-2 p-sm-3 overflow-auto" style="max-height: 450px;"
                    *ngIf="!!model?.Attachments?.length">
                    <div class="text-nowrap" *ngFor="let w of attachmentWrappers(model); let i = index;"
                        [class.bg-light]="i % 2 === 1000">
                        <div class="border-bottom d-flex align-items-center">
                            <!-- Icon -->
                            <div class="px-3 pt-1 pb-2">
                                <fa-icon [style.color]="colorFromExtension(w.attachment.FileExtension)"
                                    style="font-size: 200%;" [icon]="iconFromExtension(w.attachment.FileExtension)">
                                </fa-icon>
                            </div>

                            <!-- Everything Right of Icon -->
                            <div class="d-flex flex-column justify-content-center flex-grow-1 px-1"
                                style="min-width: 0px;">
                                <!-- Top Row -->
                                <div class="d-flex align-items-stretch" style="max-width: 750px;"
                                    *ngIf="!isEdit; else editAttachment">
                                    <button type="button"
                                        class="btn btn-link p-0 text-primary border-top-0 border-left-0 border-right-0 text-truncate"
                                        (click)="onPreviewAttachment(model, i)">{{ fileName(w) }}</button>
                                    <div class="mx-2 flex-grow-1" *ngIf="w.previewing" style="min-width: 0;">
                                        <t-spinner class="text-black"></t-spinner>
                                    </div>
                                </div>
                                <ng-template #editAttachment>
                                    <div style="max-width: 500px;">
                                        <t-form-group [serverErrors]="attachmentSeverError(w.attachment?.serverErrors)">
                                            <t-text-editor [(ngModel)]="w.attachment.FileName"
                                                [ngModelOptions]="{ updateOn: 'blur' }" required>
                                            </t-text-editor>
                                        </t-form-group>
                                    </div>
                                </ng-template>
                                <!-- Bottom Row -->
                                <div class="d-flex align-items-stretch">
                                    <!-- Audit info and Size -->
                                    <div class="flex-grow-1 small text-muted text-truncate" style="min-width: 0px;">
                                        <span *ngIf="w.attachment.CreatedById">{{ 'AttachmentAudit' | translate: {
                                            '0': ( w.attachment.CreatedAt | datetimeFormat),
                                            '1': ws.getMultilingualValue('User', w.attachment.CreatedById, 'Name')
                                            }
                                            }}&nbsp;</span>
                                        <span>({{ size(w) }})</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Commands -->
                            <div class="mx-1">
                                <ng-container *ngIf="isEdit; else viewCommands">
                                    <!-- Preview Button -->
                                    <button *ngIf="!w.previewing; else spinner"
                                        class="btn btn-sm text-primary p-0 px-1 t-toolbar-button btn-light t-white-button"
                                        (click)="onPreviewAttachment(model, i)" [title]="'Preview' | translate">
                                        <fa-icon icon="eye"></fa-icon>
                                    </button>

                                    <!-- Download Button -->
                                    <button *ngIf="!w.downloading; else spinner"
                                        class="btn btn-sm text-primary p-0 px-1 t-toolbar-button btn-light t-white-button"
                                        (click)="onDownloadAttachment(model, i)" [title]="'Download' | translate">
                                        <fa-icon icon="download"></fa-icon>
                                    </button>

                                    <!-- Delete button -->
                                    <button
                                        class="btn btn-sm text-primary p-0 px-1 t-toolbar-button btn-light t-white-button"
                                        (click)="onDeleteAttachment(model, i)" [title]="'Delete' | translate">
                                        <fa-icon icon="trash"></fa-icon>
                                    </button>
                                </ng-container>
                                <ng-template #viewCommands>
                                    <!-- Download Button -->
                                    <button *ngIf="!w.downloading; else spinner"
                                        class="btn btn-sm text-primary p-0 px-1 t-toolbar-button btn-light t-white-button"
                                        (click)="onDownloadAttachment(model, i)" [title]="'Download' | translate">
                                        <fa-icon icon="download"></fa-icon>
                                    </button>
                                </ng-template>

                                <!-- Spinner -->
                                <ng-template #spinner>
                                    <div class="px-1 t-toolbar-button d-inline t-vertical-align-middle">
                                        <t-spinner class="text-black"></t-spinner>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div class="py-2 px-3 col-12 d-flex align-items-center justify-content-end" *ngIf="isEdit">
                    <button class="btn btn-sm btn-primary text-primary2 btn-light2 t-white-button2"
                        (click)="fileInput.click()">
                        <fa-icon icon="upload"></fa-icon>
                        &nbsp;&nbsp;{{ (model?.Attachments?.length > 0 ? 'UploadMore' : 'Upload') | translate }}
                    </button>
                </div>
            </ng-template>
        </li>
    </ul>

    <!-- Tab Contents -->
    <div class="w-100" [ngbNavOutlet]="tabs">

    </div>

    <!-- for the file dialog -->
    <input type="file" class="d-none" #fileInput (change)="onFileSelected(fileInput, model)" multiple />

    <!------------ Templates for Manual Lines ----------->
    <ng-template #manualLines>

        <!-- Manual Entries Table -->
        <t-table [dataSource]="manualEntries(model)" [isEdit]="isEdit" [itemSize]="70"
            [columnPaths]="manualColumnPaths(model)" [columnTemplates]="{
                            'AccountId' : { headerTemplate : header_Account, rowTemplate : row_Account, weight : 3 },
                            'Debit' : { headerTemplate : header_Debit, rowTemplate : row_Debit, weight : 1 },
                            'Credit' : { headerTemplate : header_Credit, rowTemplate : row_Credit, weight : 1 },
                            'Center' : { headerTemplate : header_Center, rowTemplate : row_Center, weight : 1 },
                            'Memo' : { headerTemplate : header_Memo, rowTemplate : row_Memo, weight : 2 },
                            'Commands' : { headerTemplate: header_ManualEntryCommands, rowTemplate : row_ManualEntryCommands }
                        }" [onNewItem]="onNewManualEntry" (insert)="onInsertManualEntry($event, model)"
            (delete)="onDeleteManualEntry($event, model)">
        </t-table>

        <!-- Manual Line Properties -->
        <div class="row m-0 py-2" *ngIf="showManualLineProps(model)">
            <!-- Posting Date -->
            <t-form-group class="t-form-group" *ngIf="!showDocumentPostingDate(model)"
                [label]="'Line_PostingDate' | translate" [serverErrors]="manualLine(model)?.serverErrors?.PostingDate">
                <t-restricted *ngIf="!isEdit" [metadata]="manualLine(model)?.EntityMetadata?.PostingDate">
                    <div>{{ manualLine(model)?.PostingDate | dateFormat }}</div>
                </t-restricted>
                <t-date-picker *ngIf="isEdit" required [(ngModel)]="manualLine(model).PostingDate"
                    [ngModelOptions]="{ updateOn: 'blur' }">
                </t-date-picker>
            </t-form-group>

            <!-- Memo -->
            <t-form-group class="t-form-group" *ngIf="!showDocumentMemo(model)" [label]="'Memo' | translate"
                [serverErrors]="manualLine(model)?.serverErrors?.Memo">
                <t-restricted *ngIf="!isEdit" [metadata]="manualLine(model)?.EntityMetadata?.Memo">
                    <div [innerHTML]="manualLine(model)?.Memo | linky"></div>
                </t-restricted>
                <t-text-editor *ngIf="isEdit" required [(ngModel)]="manualLine(model).Memo"
                    [ngModelOptions]="{ updateOn: 'blur' }">
                </t-text-editor>
            </t-form-group>
        </div>
    </ng-template>

    <!-- Account + Dynamic Properties -->
    <ng-template #header_Account>{{ 'Entry_Account' | translate }}</ng-template>
    <ng-template #row_Account let-pair="item" let-entry="item.entry" let-index="index" let-update="update"
        let-bookkeeping="argument">

        <!-- Account -->
        <div>
            <t-form-group-dynamic class="t-form-group" [serverErrors]="entry.serverErrors?.AccountId">
                <!-- <span *ngIf="isCredit(entry)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> -->
                <t-restricted [metadata]="entry.EntityMetadata?.AccountId" *ngIf="!isEdit">
                    <t-view-link link="../../../accounts" [itemId]="entry?.AccountId">
                        {{ accountDisplay(entry?.AccountId) }}</t-view-link>
                    <span class="text-muted font-italic" *ngIf="bookkeeping && !entry?.AccountId">{{ 'Undefined' |
                        translate }}</span>
                </t-restricted>
                <t-accounts-picker *ngIf="isEdit" style="min-width: 150px;" [(ngModel)]="entry.AccountId"
                    (ngModelChange)="update.call(null, pair);" [additionalSelect]="additionalSelectAccount"
                    [filter]="filterAccount(pair, bookkeeping)">
                </t-accounts-picker>
            </t-form-group-dynamic>
        </div>

        <!-- Dynamic Properties -->
        <div class="small d-flex flex-wrap px-2 pt-1">
            <!-- Currency -->
            <ng-container *ngIf="showCurrency(entry)">
                <t-form-group-dynamic [label]="'Entry_Currency' | translate"
                    [serverErrors]="entry.serverErrors?.CurrencyId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.CurrencyId">
                        <t-view-link link="../../../currencies" [itemId]="entry.CurrencyId">
                            {{ ws.getMultilingualValue('Currency', entry.CurrencyId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <t-currencies-picker *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.CurrencyId"
                        (ngModelChange)="update.call(null, pair);" required>
                    </t-currencies-picker>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Monetary Value -->
            <ng-container *ngIf="showMonetaryValue(entry)">
                <t-form-group-dynamic [label]="'Entry_MonetaryValue' | translate"
                    [serverErrors]="entry.serverErrors?.MonetaryValue">
                    <!-- View -->
                    <ng-container *ngIf="!isEdit || bookkeeping">
                        <t-restricted [metadata]="entry.EntityMetadata?.MonetaryValue">
                            {{ entry.MonetaryValue | accounting:MonetaryValue_format(entry) }}
                        </t-restricted>
                    </ng-container>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-decimal-editor [(ngModel)]="entry.MonetaryValue"
                            [maxDecimalPlaces]="MonetaryValue_decimals(entry)"
                            [minDecimalPlaces]="MonetaryValue_decimals(entry)"
                            (ngModelChange)="update.call(null, pair);" [ngModelOptions]="{ updateOn: 'blur' }"
                            textAlignment="right" required>
                        </t-decimal-editor>
                    </ng-container>
                    <!-- Readonly Currency -->
                    <ng-container *ngIf="!showCurrency(entry)">
                        &nbsp;
                        <t-restricted [metadata]="entry.EntityMetadata?.CurrencyId">
                            {{ ws.getMultilingualValue('Currency', isEdit ? readonlyValueCurrencyId(entry) :
                            entry.CurrencyId, 'Name') }}
                        </t-restricted>

                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Agent -->
            <ng-container *ngIf="showAgent_Manual(entry)">
                <t-form-group-dynamic [label]="labelAgent_Manual(entry)" [serverErrors]="entry.serverErrors?.AgentId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.AgentId">
                        <t-view-link [link]="'../../../agents/' + ws.get('Agent', entry.AgentId)?.DefinitionId"
                            [itemId]="entry.AgentId">
                            {{ ws.getMultilingualValue('Agent', entry.AgentId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-agents-picker *ngIf="!readonlyAgent_Manual(entry)" [(ngModel)]="entry.AgentId"
                            (ngModelChange)="update.call(null, pair);" [additionalSelect]="additionalSelectAgent"
                            [definitionIds]="definitionIdsAgent_Manual(entry)" required>
                        </t-agents-picker>
                        <t-restricted *ngIf="readonlyAgent_Manual(entry)" [metadata]="entry.EntityMetadata?.AgentId">
                            {{ ws.getMultilingualValue('Agent', readonlyValueAgentId_Manual(entry), 'Name') }}
                        </t-restricted>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Noted Agent -->
            <ng-container *ngIf="showNotedAgent_Manual(entry)">
                <t-form-group-dynamic [label]="labelNotedAgent_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.NotedAgentId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.NotedAgentId">
                        <t-view-link [link]="'../../../agents/' + ws.get('Agent', entry.NotedAgentId)?.DefinitionId"
                            [itemId]="entry.NotedAgentId">
                            {{ ws.getMultilingualValue('Agent', entry.NotedAgentId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-agents-picker *ngIf="!readonlyNotedAgent_Manual(entry)" [(ngModel)]="entry.NotedAgentId"
                            (ngModelChange)="update.call(null, pair);" [additionalSelect]="additionalSelectNotedAgent"
                            [definitionIds]="definitionIdsNotedAgent_Manual(entry)" required>
                        </t-agents-picker>
                        <t-restricted *ngIf="readonlyNotedAgent_Manual(entry)"
                            [metadata]="entry.EntityMetadata?.NotedAgentId">
                            {{ ws.getMultilingualValue('Agent', readonlyValueNotedAgentId_Manual(entry), 'Name')
                            }}
                        </t-restricted>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Noted Resource -->
            <ng-container *ngIf="showNotedResource_Manual(entry)">
                <t-form-group-dynamic [label]="labelNotedResource_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.NotedResourceId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.NotedResourceId">
                        <t-view-link
                            [link]="'../../../resources/' + ws.get('Resource', entry.NotedResourceId)?.DefinitionId"
                            [itemId]="entry.NotedResourceId">
                            {{ ws.getMultilingualValue('Resource', entry.NotedResourceId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-resources-picker *ngIf="!readonlyNotedResource_Manual(entry)"
                            [(ngModel)]="entry.NotedResourceId" (ngModelChange)="update.call(null, pair);"
                            [additionalSelect]="additionalSelectNotedResource"
                            [definitionIds]="definitionIdsNotedResource_Manual(entry)" required>
                        </t-resources-picker>
                        <t-restricted *ngIf="readonlyNotedResource_Manual(entry)"
                            [metadata]="entry.EntityMetadata?.NotedResourceId">
                            {{ ws.getMultilingualValue('Resource', readonlyValueNotedResourceId_Manual(entry), 'Name')
                            }}
                        </t-restricted>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Resource -->
            <ng-container *ngIf="showResource_Manual(entry)">
                <t-form-group-dynamic [label]="labelResource_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.ResourceId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.ResourceId">
                        <t-view-link [link]="'../../../resources/' + ws.get('Resource', entry.ResourceId)?.DefinitionId"
                            [itemId]="entry.ResourceId">
                            {{ ws.getMultilingualValue('Resource', entry.ResourceId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-resources-picker *ngIf="!readonlyResource_Manual(entry)" [(ngModel)]="entry.ResourceId"
                            (ngModelChange)="update.call(null, pair);" [additionalSelect]="additionalSelectResource"
                            [definitionIds]="definitionIdsResource_Manual(entry)" required>
                        </t-resources-picker>
                        <t-restricted *ngIf="readonlyResource_Manual(entry)"
                            [metadata]="entry.EntityMetadata?.ResourceId">
                            {{ ws.getMultilingualValue('Resource', readonlyValueResourceId_Manual(entry), 'Name') }}
                        </t-restricted>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Quantity + Unit -->
            <ng-container *ngIf="showQuantity(entry)">
                <t-form-group-dynamic [label]="'Entry_Quantity' | translate"
                    [serverErrors]="entry.serverErrors?.Quantity">
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.Quantity">
                        <span>{{ entry.Quantity | accounting:'1.0-4'}}</span>
                    </t-restricted>
                    <t-decimal-editor *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.Quantity" [maxDecimalPlaces]="4"
                        [minDecimalPlaces]="0" (ngModelChange)="update.call(null, pair);"
                        [ngModelOptions]="{ updateOn: 'blur' }" required>
                    </t-decimal-editor>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>
            <ng-container *ngIf="showUnit(entry)">
                <t-form-group-dynamic [label]="'Entry_Unit' | translate" [serverErrors]="entry.serverErrors?.UnitId">
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.UnitId">
                        <!-- <t-view-link link="../../../units" [itemId]="entry.UnitId"> -->
                        {{ ws.getMultilingualValue('Unit', entry.UnitId, 'Name') }}
                        <!-- </t-view-link> -->
                    </t-restricted>
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-restricted *ngIf="readonlyUnit(entry)" [metadata]="entry.EntityMetadata?.UnitId">
                            {{ ws.getMultilingualValue('Unit', readonlyValueUnitId(entry), 'Name') }}
                        </t-restricted>
                        <t-units-picker *ngIf="!readonlyUnit(entry)" [(ngModel)]="entry.UnitId"
                            (ngModelChange)="update.call(null, pair);" [filter]="filterUnitId(entry)">
                        </t-units-picker>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Time1 -->
            <ng-container *ngIf="showTime1_Manual(entry)">
                <t-form-group-dynamic [label]="labelTime1_Manual(entry)" [serverErrors]="entry.serverErrors?.Time1">
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.Time1">
                        {{ entry.Time1 | dateFormat}}
                    </t-restricted>
                    <t-date-picker *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.Time1"
                        (ngModelChange)="update.call(null, pair);" [ngModelOptions]="{ updateOn: 'blur' }">
                    </t-date-picker>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Duration + DurationUnit -->
            <ng-container *ngIf="showDuration(entry)">
                <t-form-group-dynamic [label]="'Entry_Duration' | translate"
                    [serverErrors]="entry.serverErrors?.Duration">
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.Duration">
                        <span>{{ entry.Duration | accounting:'1.0-4'}}</span>
                    </t-restricted>
                    <t-decimal-editor *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.Duration" [maxDecimalPlaces]="4"
                        [minDecimalPlaces]="0" (ngModelChange)="update.call(null, pair);"
                        [ngModelOptions]="{ updateOn: 'blur' }" required>
                    </t-decimal-editor>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>
            <ng-container *ngIf="showDurationUnit(entry, pair.line)">
                <t-form-group-dynamic [label]="'Entry_DurationUnit' | translate"
                    [serverErrors]="entry.serverErrors?.DurationUnitId">
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.DurationUnitId">
                        <!-- <t-view-link link="../../../units" [itemId]="entry.DurationUnitId"> -->
                        {{ ws.getMultilingualValue('Unit', entry.DurationUnitId, 'Name') }}
                        <!-- </t-view-link> -->
                    </t-restricted>
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-restricted *ngIf="readonlyDurationUnit(entry)"
                            [metadata]="entry.EntityMetadata?.DurationUnitId">
                            {{ ws.getMultilingualValue('Unit', readonlyValueDurationUnitId(entry), 'Name') }}
                        </t-restricted>
                        <t-units-picker *ngIf="!readonlyDurationUnit(entry)" [(ngModel)]="entry.DurationUnitId"
                            (ngModelChange)="update.call(null, pair);" [filter]="filterDurationUnitId(entry)">
                        </t-units-picker>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Time2 -->
            <ng-container *ngIf="showTime2_Manual(entry)">
                <t-form-group-dynamic [label]="labelTime2_Manual(entry)" [serverErrors]="entry.serverErrors?.Time2">
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.Time2">
                        {{ entry.Time2 | dateFormat}}
                    </t-restricted>
                    <t-date-picker *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.Time2"
                        (ngModelChange)="update.call(null, pair);" [ngModelOptions]="{ updateOn: 'blur' }">
                    </t-date-picker>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Entry Type -->
            <ng-container *ngIf="showEntryType_Manual(entry)">
                <t-form-group-dynamic [label]="'Entry_EntryType' | translate"
                    [serverErrors]="entry.serverErrors?.EntryTypeId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.EntryTypeId">
                        <t-view-link link="../../../entry-types" [itemId]="entry.EntryTypeId">
                            <div class="text-truncate">
                                {{ ws.getMultilingualValue('EntryType', entry.EntryTypeId, 'Name') }}
                            </div>
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-entry-types-picker *ngIf="!readonlyEntryType_Manual(entry)" [(ngModel)]="entry.EntryTypeId"
                            (ngModelChange)="update.call(null, pair);" [filter]="filterEntryType_Manual(entry)"
                            required>
                        </t-entry-types-picker>
                        <t-restricted *ngIf="readonlyEntryType_Manual(entry)"
                            [metadata]="entry.EntityMetadata?.EntryTypeId">
                            <div class="text-truncate">
                                {{ ws.getMultilingualValue('EntryType', readonlyValueEntryTypeId_Manual(entry), 'Name')
                                }}
                            </div>
                        </t-restricted>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- External Reference -->
            <ng-container *ngIf="showExternalReference_Manual(entry)">
                <t-form-group-dynamic [label]="labelExternalReference_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.ExternalReference">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.ExternalReference">
                        <div class="text-truncate">
                            {{ entry.ExternalReference }}
                        </div>
                    </t-restricted>
                    <!-- Edit -->
                    <t-text-editor *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.ExternalReference"
                        (ngModelChange)="update.call(null, pair);">
                    </t-text-editor>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!--ReferenceSource -->
            <ng-container *ngIf="showReferenceSource_Manual(entry)">
                <t-form-group-dynamic [label]="labelReferenceSource_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.ReferenceSourceId">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.ReferenceSourceId">
                        <t-view-link
                            [link]="'../../../agents/' + ws.get('Agent', entry.ReferenceSourceId)?.DefinitionId"
                            [itemId]="entry.ReferenceSourceId">
                            {{ ws.getMultilingualValue('Agent', entry.ReferenceSourceId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <!-- Edit -->
                    <ng-container *ngIf="isEdit && !bookkeeping">
                        <t-agents-picker *ngIf="!readonlyReferenceSource_Manual(entry)"
                            [(ngModel)]="entry.ReferenceSourceId" (ngModelChange)="update.call(null, pair);"
                            [definitionIds]="definitionIdsReferenceSource_Manual(entry)" required>
                        </t-agents-picker>
                        <t-restricted *ngIf="readonlyReferenceSource_Manual(entry)"
                            [metadata]="entry.EntityMetadata?.AgentId">
                            {{ ws.getMultilingualValue('Agent', readonlyValueReferenceSourceId_Manual(entry), 'Name')
                            }}
                        </t-restricted>
                    </ng-container>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Internal Reference -->
            <ng-container *ngIf="showInternalReference_Manual(entry)">
                <t-form-group-dynamic [label]="labelInternalReference_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.InternalReference">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.InternalReference">
                        <div class="text-truncate">
                            {{ entry.InternalReference }}
                        </div>
                    </t-restricted>
                    <!-- Edit -->
                    <t-text-editor *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.InternalReference"
                        (ngModelChange)="update.call(null, pair);">
                    </t-text-editor>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Noted Agent Name -->
            <ng-container *ngIf="showNotedAgentName_Manual(entry)">
                <t-form-group-dynamic [label]="labelNotedAgentName_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.NotedAgentName">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.NotedAgentName">
                        <div class="text-truncate">
                            {{ entry.NotedAgentName }}
                        </div>
                    </t-restricted>
                    <!-- Edit -->
                    <t-text-editor *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.NotedAgentName"
                        (ngModelChange)="update.call(null, pair);">
                    </t-text-editor>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Noted Amount -->
            <ng-container *ngIf="showNotedAmount_Manual(entry)">
                <t-form-group-dynamic [label]="labelNotedAmount_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.NotedAmount">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.NotedAmount">
                        <div class="text-truncate">
                            {{ entry.NotedAmount | accounting:MonetaryValue_format(entry) }}
                        </div>
                    </t-restricted>
                    <!-- Edit -->
                    <t-decimal-editor *ngIf="isEdit && !bookkeeping" [minDecimalPlaces]="MonetaryValue_decimals(entry)"
                        [maxDecimalPlaces]="MonetaryValue_decimals(entry)" [(ngModel)]="entry.NotedAmount"
                        (ngModelChange)="update.call(null, pair);">
                    </t-decimal-editor>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>

            <!-- Noted Date -->
            <ng-container *ngIf="showNotedDate_Manual(entry)">
                <t-form-group-dynamic [label]="labelNotedDate_Manual(entry)"
                    [serverErrors]="entry.serverErrors?.NotedDate">
                    <!-- View -->
                    <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.NotedDate">
                        <div class="text-truncate">
                            {{ entry.NotedDate | dateFormat }}
                        </div>
                    </t-restricted>
                    <!-- Edit -->
                    <t-date-picker *ngIf="isEdit && !bookkeeping" [(ngModel)]="entry.NotedDate"
                        (ngModelChange)="update.call(null, pair);">
                    </t-date-picker>
                    &nbsp;&nbsp;
                </t-form-group-dynamic>
            </ng-container>
        </div>
    </ng-template>

    <!-- Center -->
    <ng-template #header_Center>{{ 'Entry_Center' | translate }}</ng-template>
    <ng-template #row_Center let-pair="item" let-entry="item.entry" let-index="index" let-update="update"
        let-bookkeeping="argument">
        <t-restricted *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.CenterId">
            <t-view-link link="../../../centers" [itemId]="entry.CenterId">
                {{ ws.getMultilingualValue('Center', entry.CenterId, 'Name') }}
            </t-view-link>
        </t-restricted>
        <ng-container *ngIf="isEdit && !bookkeeping">
            <t-form-group-dynamic class="t-form-group" [serverErrors]="entry.serverErrors?.CenterId">
                <t-centers-picker *ngIf="!readonlyCenter_Manual(entry)" [(ngModel)]="entry.CenterId"
                    (ngModelChange)="update.call(null, pair);" [filter]="filterCenter_Manual(entry)">
                </t-centers-picker>
                <t-restricted *ngIf="readonlyCenter_Manual(entry)" [metadata]="entry.EntityMetadata?.CenterId">
                    {{ ws.getMultilingualValue('Center', readonlyValueCenterId_Manual(entry), 'Name') }}
                </t-restricted>
            </t-form-group-dynamic>
        </ng-container>
    </ng-template>

    <!-- Debit -->
    <ng-template #header_Debit>
        <div style="float: right">{{ ('Debit' | translate) + functionalPostfix }}</div>
    </ng-template>
    <ng-template #row_Debit let-pair="item" let-entry="item.entry" let-index="index" let-update="update"
        let-bookkeeping="argument">
        <t-restricted class="h-100" *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.Value">
            <div style="float: right">{{ getDebit(entry) | accounting:functional_format }}</div>
        </t-restricted>
        <t-form-group-dynamic *ngIf="isEdit && !bookkeeping" class="t-form-group"
            [serverErrors]="entry.serverErrors?.Value">
            <t-decimal-editor [ngModel]="getDebit(entry)" [maxDecimalPlaces]="functional_decimals"
                [minDecimalPlaces]="functional_decimals" textAlignment="right"
                (ngModelChange)="setDebit(entry, $event); update.call(null, pair);"
                [ngModelOptions]="{ updateOn: 'blur' }">
            </t-decimal-editor>
        </t-form-group-dynamic>
        <ng-container
            *ngTemplateOutlet="autofillFromExchangeRate; context: { direction: 1, pair: pair, bookkeeping: bookkeeping }">
        </ng-container>
    </ng-template>

    <!-- Credit -->
    <ng-template #header_Credit>
        <div style="float: right">{{ ('Credit' | translate) + functionalPostfix }}</div>
    </ng-template>
    <ng-template #row_Credit let-pair="item" let-entry="item.entry" let-index="index" let-update="update"
        let-bookkeeping="argument">
        <t-restricted class="h-100" *ngIf="!isEdit || bookkeeping" [metadata]="entry.EntityMetadata?.Value">
            <div style="float: right">{{ getCredit(entry) | accounting:functional_format }}</div>
        </t-restricted>
        <t-form-group-dynamic *ngIf="isEdit && !bookkeeping" class="t-form-group"
            [serverErrors]="entry.serverErrors?.Value">
            <t-decimal-editor [ngModel]="getCredit(entry)" [maxDecimalPlaces]="functional_decimals"
                [minDecimalPlaces]="functional_decimals" textAlignment="right"
                (ngModelChange)="setCredit(entry, $event); update.call(null, pair);"
                [ngModelOptions]="{ updateOn: 'blur' }">
            </t-decimal-editor>
        </t-form-group-dynamic>
        <ng-container
            *ngTemplateOutlet="autofillFromExchangeRate; context: { direction: -1, pair: pair, bookkeeping: bookkeeping }">
        </ng-container>
    </ng-template>

    <!-- Fill from Exchange Rate button -->
    <ng-template #autofillFromExchangeRate let-pair="pair" let-direction="direction" let-bookkeeping="bookkeeping">
        <div class="d-flex justify-content-end pt-1"
            *ngIf="!bookkeeping && isEdit && !pair.PH && showMonetaryValue(pair.entry)">
            <t-spinner *ngIf="!!pair.subscription && pair.direction === direction"></t-spinner>
            <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1"
                (click)="onAutofillFromExchangeRate(pair, model, direction)" tabindex="-1">
                <fa-icon icon="exchange-alt" [title]="'AutofillFromExchangeRate' | translate">
                </fa-icon>
            </button>
        </div>
    </ng-template>

    <!-- Memo -->
    <ng-template #header_Memo>{{ 'Memo' | translate }}</ng-template>
    <ng-template #row_Memo let-pair="item" let-line="item.line" let-index="index" let-update="update"
        let-bookkeeping="argument">
        <t-form-group-dynamic class="t-form-group" [serverErrors]="line.serverErrors?.Memo">
            <div *ngIf="!isEdit || bookkeeping">
                <t-restricted [metadata]="line.EntityMetadata?.Memo"><span
                        [innerHTML]="line?.Memo | linky"></span></t-restricted>
            </div>
            <t-text-editor *ngIf="isEdit && !bookkeeping" [(ngModel)]="line.Memo"
                (ngModelChange)="update.call(null, pair)" [ngModelOptions]="{ updateOn: 'blur' }">
            </t-text-editor>
        </t-form-group-dynamic>
    </ng-template>

    <!-- Warning of Modified Rows -->
    <ng-template #row_ModifiedWarning let-pair="item" let-line="item.line" let-index="index" let-update="update"
        let-bookkeeping="argument">
        <fa-icon *ngIf="getIsModified(line, model)" icon="exclamation-triangle" class="text-warning"
            [placement]="modifiedTooltipPlacement" [ngbTooltip]="'ModifiedLineWarning' | translate" container="body">
        </fa-icon>
    </ng-template>

    <!-- Commands for Smart entries -->
    <ng-template #row_SmartEntryCommands let-pair="item" let-line="item.line">
        <div ngbDropdown [placement]="commandsDropdownPlacement">
            <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1 t-no-arrow align-baseline"
                ngbDropdownToggle><span class="small">
                    <fa-icon icon="ellipsis-v" tabindex="-1"></fa-icon>
                </span></button>
            <div ngbDropdownMenu>
                <button ngbDropdownItem class="t-transparent-background" (click)="toggleHighlight(line, model)">
                    {{ (isHighlighted(line, model) ? 'RemoveHighlight' : 'AddHighlight') | translate }}
                </button>
                <button ngbDropdownItem class="t-transparent-background" *ngIf="hasManualLines && isEdit"
                    (click)="onReverse(pair, model, isEdit)">
                    {{ 'Reverse' | translate }}
                </button>
            </div>
        </div>
    </ng-template>

    <!-- Commands for Manual entries table -->
    <ng-template #header_ManualEntryCommands>
        <div ngbDropdown [placement]="commandsDropdownPlacement" *ngIf="isEdit">
            <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1 t-no-arrow align-baseline"
                ngbDropdownToggle><span class="small">
                    <fa-icon icon="ellipsis-v" tabindex="-1"></fa-icon>
                </span></button>
            <div ngbDropdownMenu>
                <button ngbDropdownItem class="t-transparent-background"
                    (click)="onDeleteAllManualEntries(model, isEdit)">
                    {{ 'DeleteAll' | translate }}
                </button>
            </div>
        </div>
    </ng-template>

    <!-- Commands for Manual entries -->
    <ng-template #row_ManualEntryCommands let-pair="item" let-update="update">
        <div ngbDropdown [placement]="commandsDropdownPlacement" *ngIf="isEdit">
            <button class="btn btn-light text-primary t-white-button btn-sm py-0 px-1 t-no-arrow align-baseline"
                ngbDropdownToggle tabindex="-1"><span class="small">
                    <fa-icon icon="ellipsis-v"></fa-icon>
                </span></button>
            <div ngbDropdownMenu>
                <!-- <button ngbDropdownItem class="t-transparent-background" (click)="onCloneManualLine(pair, model)">
                    {{ 'Clone' | translate }}
                </button> -->
                <button ngbDropdownItem class="t-transparent-background" (click)="onAutoBalance(pair, model, update);">
                    {{ 'AutoBalance' | translate }}
                </button>
                <button ngbDropdownItem class="t-transparent-background"
                    (click)="onCloneManualLine(pair, model, isEdit)">
                    {{ 'Clone' | translate }}
                </button>
            </div>
        </div>
    </ng-template>
</ng-template>

<ng-template #sidebar let-model="model" let-isEdit="isEdit">
    <div class="d-flex justify-content-center px-0 px-sm-2">
        <div class="w-100 t-paper-width">
            <!-- <div class="px-3 py-3 small font-weight-bold" *ngIf="!!model.AssigneeId">{{ 'Workflow' | translate }}</div> -->

            <!-- Currently with -->
            <div class="bg-light border-bottom py-2 px-3" *ngIf="!!model.AssigneeId">
                <div class="d-flex">
                    <t-image [src]="'users/' + model.AssigneeId + '/image'"
                        [imageId]="ws.get('User', model.AssigneeId)?.ImageId" [size]="picSize" shape="circle"></t-image>
                    <div class="p-2 text-truncate">
                        <t-view-link link="../../../users" [itemId]="model.AssigneeId">
                            {{ ws.getMultilingualValue('User', model.AssigneeId, 'Name') }}</t-view-link>
                        {{ 'OwnsThisDocument' | translate }}
                    </div>
                </div>

                <!-- Assign the document -->
                <div class="px-2 pb-2 pt-0" [style.margin-left.px]="marginLeft" [style.margin-right.px]="marginRight"
                    *ngIf="showAssignDocument(model)">
                    <div class="form-group">
                        <label class="small font-weight-bold" for="user">{{ 'AssignTo' | translate }}</label>
                        <div class="bg-white border t-borderless-input p-1">
                            <t-users-picker id="user" [(ngModel)]="assigneeId"
                                [filter]="'IsService eq false and Id ne ' + model.AssigneeId" [showCreate]="false">
                            </t-users-picker>
                        </div>
                    </div>
                    <div class="form-group">
                        <!-- <label class="small font-weight-bold" for="message">Message (Optional)</label> -->
                        <textarea class="form-control t-input p-1 border bg-white" id="message"
                            placeholder="{{ 'OptionalMessage' | translate }}" [(ngModel)]="comment"></textarea>
                    </div>
                    <button class="btn btn-primary btn-sm" (click)="onAssign(model)"
                        [disabled]="!canAssign(model, isEdit)">{{ 'Assign' | translate }}&nbsp;&nbsp;<fa-icon
                            [icon]="assignIcon"></fa-icon></button>
                </div>
            </div>

            <!-- All history -->
            <ng-container *ngFor="let dayEvents of sortChronologically(model)">
                <div class="px-3 py-3 small font-weight-bold">{{ dayEvents.date }}</div>

                <!-- Day's history -->
                <ng-container *ngFor="let event of dayEvents.events; let i = index;">
                    <div class="bg-light border-bottom pt-2 pb-2 px-3" [class.border-top]="i === 0"
                        [ngSwitch]="event.type">

                        <!-- State Update -->
                        <ng-container *ngSwitchCase="'state'">
                            <div class="d-flex">
                                <t-image [src]="'users/' + event.userId + '/image'"
                                    [imageId]="ws.get('User', event.userId)?.ImageId" [size]="36" shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="event.userId">
                                        {{ ws.getMultilingualValue('User', event.userId, 'Name') }}</t-view-link>
                                    {{ stateUpdateDisplay(event) | translate }}
                                </div>
                                <div class="py-2 text-truncate">
                                    <span class="small text-muted">
                                        {{ event.time | timeFormat }}
                                    </span>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Reassignment -->
                        <ng-container *ngSwitchCase="'reassignment'">
                            <div class="d-flex flex-wrap">
                                <t-image [src]="'users/' + event.userId + '/image'"
                                    [imageId]="ws.get('User', event.userId)?.ImageId" [size]="36" shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="event.userId">
                                        {{ ws.getMultilingualValue('User', event.userId, 'Name') }}
                                    </t-view-link>
                                </div>
                                &nbsp;
                                <div class="pt-2">
                                    <fa-icon icon="angle-right" [flip]="flip" [size]="120"></fa-icon>
                                </div>
                                &nbsp;
                                &nbsp;
                                <t-image [src]="'users/' + reassignment(event).assigneeId + '/image'"
                                    [imageId]="ws.get('User', reassignment(event).assigneeId)?.ImageId" [size]="36"
                                    shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="reassignment(event).assigneeId">
                                        {{ ws.getMultilingualValue('User', reassignment(event).assigneeId, 'Name') }}
                                    </t-view-link>
                                </div>
                                <div class="py-2 text-truncate">
                                    <span class="my-auto t-vertical-alignment-center small text-muted">
                                        {{ event.time | timeFormat }}
                                    </span>
                                </div>
                                <div class="py-2 text-truncate" *ngIf="!!reassignment(event).modifiedTime">
                                    <span class="my-auto t-vertical-alignment-center small text-muted">
                                        &nbsp;({{ 'Modified' | translate }} {{ modifiedTime(event) }})
                                    </span>
                                </div>
                                <ng-container *ngIf="canEditAssignment(event, isEdit)">
                                    <button *ngIf="!reassignment(event).isEdit" (click)="onEditAssignment(event)"
                                        class="btn btn-sm t-toolbar-button btn-light text-primary t-white-button"
                                        [title]="'Edit' | translate">
                                        <fa-icon icon="pen" [size]="120"></fa-icon>
                                    </button>
                                </ng-container>
                            </div>
                            <div *ngIf="!!reassignment(event).comment && !reassignment(event).isEdit"
                                class="pt-1 pb-2 px-2" [style.margin-left.px]="marginLeft"
                                [style.margin-right.px]="marginRight" [innerHTML]="reassignment(event).comment | linky">
                            </div>
                            <div *ngIf="reassignment(event).isEdit" class="pt-1 pb-2 px-2"
                                [style.margin-left.px]="marginLeft" [style.margin-right.px]="marginRight">
                                <div class="mb-2">
                                    <textarea class="form-control t-input p-1 border bg-white"
                                        [(ngModel)]="reassignment(event).commentForEdit"></textarea>
                                </div>
                                <div>
                                    <button (click)="onDoEditAssignment(event)"
                                        class="btn btn-sm t-toolbar-button btn-primary" [title]="'Save' | translate">
                                        <fa-icon icon="save" [size]="120"></fa-icon>&nbsp;&nbsp;{{ 'Save' | translate
                                        }}
                                    </button>
                                    <button (click)="onCancelEditAssignment(event)"
                                        class="btn btn-sm t-toolbar-button btn-light text-primary t-white-button"
                                        [title]="'Cancel' | translate">
                                        <fa-icon icon="times" [size]="120"></fa-icon>&nbsp;&nbsp;{{ 'Cancel' | translate
                                        }}
                                    </button>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Creation -->
                        <ng-container *ngSwitchCase="'creation'">
                            <div class="d-flex">
                                <t-image [src]="'users/' + event.userId + '/image'"
                                    [imageId]="ws.get('User', event.userId)?.ImageId" [size]="36" shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="event.userId">
                                        {{ ws.getMultilingualValue('User', event.userId, 'Name') }}</t-view-link>
                                    {{ 'CreatedThisDocument' | translate }}
                                </div>
                                <div class="py-2 text-truncate">
                                    <span class="small text-muted">
                                        {{ event.time | timeFormat }}
                                    </span>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </div>
</ng-template>

<!-- Confirmation Modal -->
<ng-template #confirmModal let-modal>

    <!-- header -->
    <div class="modal-header">
        <h5 class="modal-title"> {{ 'Confirmation' | translate }} </h5>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss(false)">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <!-- body -->
    <div class="modal-body">
        {{ confirmationMessage }}
    </div>

    <!-- footer -->
    <div class="modal-footer">
        <button class="btn btn-danger" (click)="modal.close(true)">
            <fa-icon icon="check"></fa-icon>
            &nbsp;{{ 'Yes' | translate }}
        </button>
        <button class="btn btn-light text-primary t-white-button" (click)="modal.close(false)" ngbAutofocus>
            <fa-icon icon="times"></fa-icon>
            &nbsp;{{ 'No' | translate }}
        </button>
    </div>
</ng-template>

<!-- Signature Modal -->
<ng-template #signatureModal let-modal>

    <!-- header -->
    <div class="modal-header">
        <h5 class="modal-title"> {{ 'AdditionalInformation' | translate }} </h5>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss(false)">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <!-- body -->
    <div class="modal-body">

        <!-- On Behalf Of -->
        <div class="mt-3 mb-2" *ngIf="onBehalfOfUserAmbiguous">
            <div class="font-weight-bold small">
                <span class="t-vertical-align-middle">{{ 'Signature_OnBehalfOfUser' | translate }}</span>
            </div>
            <t-users-picker [(ngModel)]="onBehalfOfUserId" filter="IsService eq false and Id ne me">
            </t-users-picker>
        </div>

        <!-- Reason -->
        <div class="mt-1" *ngIf="isNegative && reasonChoicesForNegativeModal?.length > 0">
            <div class="font-weight-bold small">
                <span class="t-vertical-align-middle">{{ 'Signature_Reason' | translate }}</span>
            </div>
            <t-selector [(ngModel)]="reasonId" [choices]="reasonChoicesForNegativeModal">
            </t-selector>
        </div>

        <!-- Reason Details -->
        <div class="mt-3 mb-2" *ngIf="isNegative">
            <div class="font-weight-bold small">
                <span class="t-vertical-align-middle">{{ 'Signature_ReasonDetails' | translate }}</span>
            </div>
            <t-text-editor [(ngModel)]="reasonDetails" [ngModelOptions]="{ updateOn: 'blur' }">
            </t-text-editor>
        </div>
    </div>

    <!-- footer -->
    <div class="modal-footer">
        <button class="btn" [class.btn-danger]="isNegative" [class.btn-success]="!isNegative"
            (click)="modal.close(true)" [disabled]="onBehalfOfUserAmbiguous && !onBehalfOfUserId">
            <fa-icon icon="check"></fa-icon>
            &nbsp;{{ 'Confirm' | translate }}
        </button>
        <button class="btn btn-light text-primary t-white-button" (click)="modal.close(false)" ngbAutofocus>
            <fa-icon icon="times"></fa-icon>
            &nbsp;{{ 'Cancel' | translate }}
        </button>
    </div>
</ng-template>

<!-- Auto-Generate Modal -->
<ng-template #autoGenerateModal let-modal>

    <!-- header -->
    <div class="modal-header">
        <h5 class="modal-title"> {{ autoGenerateLabel(autoGenerateLineDefId) }} </h5>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss(false)">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <!-- body -->
    <div class="modal-body">
        <ng-container *ngFor="let param of autoGenerateLineDef.GenerateParameters; trackBy: trackByKey">
            <t-form-group *ngIf="!!param.Visibility && param.Visibility !== 'None'" class="t-form-group"
                style="margin-top:0!important" [label]="parameterLabel(param)">
                <t-editor [(ngModel)]="autoGenerateArgs[param.Key]" [desc]="parameterDesc(param)"
                    [ngModelOptions]="{ updateOn: updateOn(param) }" [showCreate]="true">
                </t-editor>
            </t-form-group>
        </ng-container>
    </div>

    <!-- footer -->
    <div class="modal-footer">
        <button class="btn btn-primary" (click)="onDoAutoGenerate(modal)"
            [disabled]="!autoGenerateRequiredParamsAreSet">
            <fa-icon icon="bolt"></fa-icon>
            &nbsp;{{ autoGenerateLabel(autoGenerateLineDefId) }}
        </button>
        <button class="btn btn-light text-primary t-white-button" (click)="modal.close(false)" ngbAutofocus>
            <fa-icon icon="times"></fa-icon>
            &nbsp;{{ 'Cancel' | translate }}
        </button>
    </div>
</ng-template>